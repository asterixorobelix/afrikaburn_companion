# Milestone v3.0: Offline Map

**Status:** SHIPPED 2026-01-20
**Phases:** 1-4
**Total Plans:** 6

## Overview

Interactive offline map for AfrikaBurn with camp/artwork markers, GPS location display, and user camp pin persistence. All functionality works without internet connectivity — critical for the remote Tankwa Karoo environment.

## Phases

### Phase 1: Foundation & Basic Map

**Goal**: Display an offline map in a new Map tab with basic navigation controls.
**Depends on**: None (foundation phase)
**Plans**: 2 plans

Plans:
- [x] 01-01: Map Infrastructure & Dependencies
- [x] 01-02: Navigation Integration & Gestures

**Details:**
- MapLibre Compose v0.11.1 integration
- Bundled PMTiles (~574KB) for Tankwa Karoo terrain
- Dark mode map style (#1a1a2e background)
- Map tab in bottom navigation (between Projects and Directions)
- Pan, pinch-zoom, and double-tap zoom gestures
- MVVM pattern: MapUiState + MapViewModel + MapScreen

**Requirements:**
- [x] MAP-01: Offline map tiles covering Tankwa Karoo region
- [x] MAP-02: Pan map by dragging
- [x] MAP-03: Zoom map by pinch gesture
- [x] MAP-04: Zoom in by double-tapping
- [x] NAV-01: Map tab in bottom navigation
- [x] NAV-02: Switch between Projects, Map, Directions, About tabs

---

### Phase 2: Markers & Detail Navigation

**Goal**: Display camp and artwork markers that navigate to detail pages when tapped.
**Depends on**: Phase 1
**Plans**: 1 plan

Plans:
- [x] 02-01: Interactive Marker Tap to Detail

**Details:**
- CircleLayer for programmatic markers (better than symbol icons)
- Camp markers: purple circles
- Artwork markers: teal circles
- Code-based matching between GeoJSON features and ProjectItem data
- Marker tap navigates to existing ProjectDetailScreen

**Requirements:**
- [x] MARK-01: Camp locations displayed as markers with distinct icon
- [x] MARK-02: Artwork locations displayed as markers with distinct icon
- [x] MARK-03: Tap camp marker to view camp details
- [x] MARK-04: Tap artwork marker to view artwork details
- [x] MARK-05: Visually distinguish camp markers from artwork markers

---

### Phase 3: User Location

**Goal**: Show the user's GPS location on the map with a "My Location" button.
**Depends on**: Phase 1
**Plans**: 1 plan

Plans:
- [x] 03-01: User Location Display & My Location FAB

**Details:**
- Custom LocationService expect/actual (Android: FusedLocationProviderClient, iOS: CLLocationManager)
- Blue dot marker for user GPS position
- My Location FAB centers map on user
- Balanced power accuracy for battery conservation
- Location tracking stops when leaving map screen
- Proper permission handling (Android runtime, iOS Info.plist)

**Requirements:**
- [x] LOC-01: User sees their current GPS location on the map
- [x] LOC-02: User can tap a button to center the map on their location
- [x] LOC-03: User is prompted to grant location permission when accessing map

---

### Phase 4: User Camp Pin

**Goal**: Allow users to mark and persist their own camp location on the map.
**Depends on**: Phase 1
**Plans**: 2 plans

Plans:
- [x] 04-01: SQLDelight Database Infrastructure
- [x] 04-02: Camp Pin UI Implementation

**Details:**
- SQLDelight 2.0.2 for local persistence (Kotlin 2.x compatible)
- UserCampPin table with CRUD queries
- Platform-specific database drivers via expect/actual
- Long-press to place camp pin (MapLibre Compose onMapLongClick)
- Confirmation dialogs for place/move/delete actions
- Orange marker (#FF9800) distinct from other markers
- 50m threshold for near-pin detection (Haversine formula)

**Requirements:**
- [x] PIN-01: User can place a camp pin by long-pressing on the map
- [x] PIN-02: User's camp pin persists after closing and reopening the app
- [x] PIN-03: User can move their camp pin to a new location
- [x] PIN-04: User can delete their camp pin

---

## Milestone Summary

**Decimal Phases:** None (clean phase progression 1→2→3→4)

**Key Decisions:**
- MapLibre Compose v0.11.1 for official KMP support and no licensing costs
- CircleLayer markers instead of symbol icons for better programmatic control
- Custom expect/actual for LocationService following CrashLogger pattern
- SQLDelight 2.0.2 for Kotlin 2.x compatibility
- Balanced power GPS accuracy for desert battery conservation
- 50m threshold for camp pin proximity detection

**Issues Resolved:**
- MapLibre Compose import paths (subpackages vs flat structure)
- Multiplatform Math.toRadians() incompatibility (custom toRadians function)
- Platform-specific Koin modules for Android Context requirement
- Detekt JVM target configuration

**Issues Deferred:**
- Map search functionality (SRCH-01/02/03) → v3.1
- Marker clustering (ENH-01) → v3.1
- Performance/event markers (ENH-05) → v3.1

**Technical Debt Incurred:**
- iOS LocationService uses @Suppress("CONFLICTING_OVERLOADS") for delegate callback
- No accuracy circle visualization around user location
- No heading/bearing indicator (just position dot)

---

*For current project status, see .planning/PROJECT.md*

---
*Archived: 2026-01-20 as part of v3.0 milestone completion*
