---
phase: 01-foundation-basic-map
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - mobile/gradle/libs.versions.toml
  - mobile/composeApp/build.gradle.kts
  - mobile/composeApp/src/commonMain/composeResources/files/maps/style.json
  - mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/ui/screens/map/MapScreen.kt
  - mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/presentation/map/MapViewModel.kt
  - mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/presentation/map/MapUiState.kt
  - mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/di/PresentationModule.kt
autonomous: true
user_setup:
  - service: map-tiles
    why: "Offline map tiles need to be generated/downloaded for Tankwa Karoo region"
    env_vars: []
    dashboard_config: []
    local_dev:
      - "Download PMTiles from Protomaps/MapTiler for Tankwa Karoo region (approx -32.35, 19.45)"
      - "Save as mobile/composeApp/src/commonMain/composeResources/files/maps/tankwa-karoo.pmtiles"
      - "Target size: 20-50MB covering zoom levels 10-16"

must_haves:
  truths:
    - "MapLibre Compose dependency is added and builds successfully"
    - "Map renders in the app showing terrain"
    - "Map tiles work without network connectivity"
  artifacts:
    - path: "mobile/gradle/libs.versions.toml"
      provides: "MapLibre Compose dependency versions"
      contains: "maplibre-compose"
    - path: "mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/ui/screens/map/MapScreen.kt"
      provides: "Basic map composable"
      min_lines: 30
    - path: "mobile/composeApp/src/commonMain/composeResources/files/maps/style.json"
      provides: "Offline map style configuration"
      contains: "sources"
  key_links:
    - from: "MapScreen.kt"
      to: "style.json"
      via: "MapLibreMap styleUri parameter"
      pattern: "styleUri.*asset://"
---

<objective>
Set up MapLibre Compose dependencies and create basic offline map infrastructure.

Purpose: Establish the foundation for offline map display, ensuring tiles and style assets work without network connectivity.
Output: Working map composable with bundled tiles (MAP-01 partial), visible in isolation (not yet integrated into navigation).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/STACK.md
@.planning/research/PITFALLS.md
@.planning/codebase/CONVENTIONS.md

@mobile/gradle/libs.versions.toml
@mobile/composeApp/build.gradle.kts
@mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/di/PresentationModule.kt
@mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/Theme.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MapLibre Compose dependencies to version catalog</name>
  <files>mobile/gradle/libs.versions.toml</files>
  <action>
    Add MapLibre Compose dependency to libs.versions.toml:

    In [versions] section:
    ```
    maplibre-compose = "0.11.1"
    ```

    In [libraries] section:
    ```
    maplibre-compose = { module = "org.maplibre.compose:maplibre-compose", version.ref = "maplibre-compose" }
    maplibre-compose-material3 = { module = "org.maplibre.compose:maplibre-compose-material3", version.ref = "maplibre-compose" }
    ```

    IMPORTANT: Pin to 0.11.1 specifically to avoid API instability issues documented in research.
  </action>
  <verify>grep -q "maplibre-compose" mobile/gradle/libs.versions.toml</verify>
  <done>MapLibre Compose version and libraries defined in version catalog</done>
</task>

<task type="auto">
  <name>Task 2: Add MapLibre dependencies to build.gradle.kts</name>
  <files>mobile/composeApp/build.gradle.kts</files>
  <action>
    In the commonMain dependencies block, add:
    ```kotlin
    implementation(libs.maplibre.compose)
    implementation(libs.maplibre.compose.material3)
    ```

    After adding, sync Gradle to ensure dependencies resolve correctly.
  </action>
  <verify>./mobile/gradlew -p mobile :composeApp:dependencies --configuration commonMainApi | grep -i maplibre</verify>
  <done>MapLibre dependencies added and resolve successfully</done>
</task>

<task type="auto">
  <name>Task 3: Create map resources directory and style.json</name>
  <files>mobile/composeApp/src/commonMain/composeResources/files/maps/style.json</files>
  <action>
    Create directory structure and style.json file for offline map rendering.

    The style.json should:
    1. Reference PMTiles source with local asset path: "pmtiles://asset://files/maps/tankwa-karoo.pmtiles"
    2. Use OpenMapTiles schema for layers
    3. Reference local fonts: "asset://files/maps/fonts/{fontstack}/{range}.pbf"
    4. Reference local sprites: "asset://files/maps/sprites/osm-bright"
    5. Include basic layers: background, water, landuse, roads, labels

    Use a minimal style focused on terrain visibility and road networks - this is desert terrain, so keep layers simple.

    NOTE: The actual .pmtiles file must be provided by user (see user_setup). Create a placeholder note file explaining this.
  </action>
  <verify>test -f mobile/composeApp/src/commonMain/composeResources/files/maps/style.json</verify>
  <done>Map style configuration created with offline asset paths</done>
</task>

<task type="auto">
  <name>Task 4: Create MapUiState sealed class</name>
  <files>mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/presentation/map/MapUiState.kt</files>
  <action>
    Create sealed interface following existing UiState patterns in the codebase.

    ```kotlin
    package io.asterixorobelix.afrikaburn.presentation.map

    sealed interface MapUiState {
        data object Loading : MapUiState
        data class Success(
            val centerLatitude: Double = -32.35,  // Tankwa Karoo center
            val centerLongitude: Double = 19.45,
            val zoomLevel: Double = 12.0
        ) : MapUiState
        data class Error(val message: String) : MapUiState
    }
    ```

    Keep it simple for Phase 1 - just camera position state. Will extend with markers, user location, etc. in later phases.
  </action>
  <verify>test -f mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/presentation/map/MapUiState.kt</verify>
  <done>MapUiState sealed class created</done>
</task>

<task type="auto">
  <name>Task 5: Create MapViewModel</name>
  <files>mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/presentation/map/MapViewModel.kt</files>
  <action>
    Create ViewModel following existing patterns (see ProjectsViewModel for reference).

    ```kotlin
    package io.asterixorobelix.afrikaburn.presentation.map

    import androidx.lifecycle.ViewModel
    import kotlinx.coroutines.flow.MutableStateFlow
    import kotlinx.coroutines.flow.StateFlow
    import kotlinx.coroutines.flow.asStateFlow

    class MapViewModel : ViewModel() {
        private val _uiState = MutableStateFlow<MapUiState>(MapUiState.Loading)
        val uiState: StateFlow<MapUiState> = _uiState.asStateFlow()

        init {
            // Initialize with default Tankwa Karoo center position
            _uiState.value = MapUiState.Success()
        }

        fun onCameraPositionChanged(latitude: Double, longitude: Double, zoom: Double) {
            val currentState = _uiState.value
            if (currentState is MapUiState.Success) {
                _uiState.value = currentState.copy(
                    centerLatitude = latitude,
                    centerLongitude = longitude,
                    zoomLevel = zoom
                )
            }
        }
    }
    ```

    Simple state management for camera position. Will extend for markers, location tracking, etc.
  </action>
  <verify>test -f mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/presentation/map/MapViewModel.kt</verify>
  <done>MapViewModel created with camera state management</done>
</task>

<task type="auto">
  <name>Task 6: Create MapScreen composable</name>
  <files>mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/ui/screens/map/MapScreen.kt</files>
  <action>
    Create the main map composable using MapLibre Compose.

    Key requirements:
    1. Use MapLibreMap composable from MapLibre Compose library
    2. Load style from bundled asset: "asset://files/maps/style.json"
    3. Set initial camera to Tankwa Karoo center (-32.35, 19.45) at zoom 12
    4. Support standard gestures (pan, zoom - enabled by default in MapLibre)
    5. Follow existing screen patterns (see ProjectsScreen for reference)
    6. Use Dimens object for any spacing/sizing (NO hardcoded dp values)
    7. Collect state from MapViewModel

    Structure:
    ```kotlin
    @Composable
    fun MapScreen(
        viewModel: MapViewModel = koinInject()
    ) {
        val uiState by viewModel.uiState.collectAsState()

        when (val state = uiState) {
            is MapUiState.Loading -> LoadingContent()
            is MapUiState.Success -> MapContent(state, viewModel::onCameraPositionChanged)
            is MapUiState.Error -> ErrorContent(state.message)
        }
    }

    @Composable
    private fun MapContent(
        state: MapUiState.Success,
        onCameraChanged: (Double, Double, Double) -> Unit
    ) {
        MapLibreMap(
            styleUri = "asset://files/maps/style.json",
            modifier = Modifier.fillMaxSize(),
            cameraPosition = CameraPosition(
                target = Position(state.centerLongitude, state.centerLatitude),
                zoom = state.zoomLevel
            )
        )
    }
    ```

    IMPORTANT: Check MapLibre Compose documentation for exact API - the CameraPosition API may differ slightly.
  </action>
  <verify>test -f mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/ui/screens/map/MapScreen.kt</verify>
  <done>MapScreen composable created with MapLibreMap integration</done>
</task>

<task type="auto">
  <name>Task 7: Register MapViewModel in Koin module</name>
  <files>mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/di/PresentationModule.kt</files>
  <action>
    Add MapViewModel factory to existing PresentationModule following the pattern used for other ViewModels.

    Add import:
    ```kotlin
    import io.asterixorobelix.afrikaburn.presentation.map.MapViewModel
    ```

    Add factory in module block:
    ```kotlin
    factory { MapViewModel() }
    ```
  </action>
  <verify>grep -q "MapViewModel" mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/di/PresentationModule.kt</verify>
  <done>MapViewModel registered in Koin dependency injection</done>
</task>

<task type="auto">
  <name>Task 8: Add Koin injection helper for MapViewModel</name>
  <files>mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/di/KoinCompose.kt</files>
  <action>
    Add a Koin injection helper for MapViewModel following the pattern used for ProjectsViewModel.

    Add import:
    ```kotlin
    import io.asterixorobelix.afrikaburn.presentation.map.MapViewModel
    ```

    Add helper function:
    ```kotlin
    @Composable
    fun koinMapViewModel(): MapViewModel {
        return koinInject<MapViewModel>()
    }
    ```

    If this file doesn't exist, the helpers may be defined elsewhere - check the codebase pattern.
  </action>
  <verify>grep -q "MapViewModel" mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/di/KoinCompose.kt || grep -rq "koinMapViewModel" mobile/composeApp/src/commonMain/kotlin/</verify>
  <done>Koin helper function added for MapViewModel injection</done>
</task>

<task type="auto">
  <name>Task 9: Verify build succeeds with new dependencies</name>
  <files></files>
  <action>
    Run Gradle build to verify:
    1. MapLibre Compose dependencies resolve correctly
    2. No duplicate class conflicts (Mapbox/MapLibre issue from pitfalls research)
    3. All new Kotlin files compile without errors

    Run: ./mobile/gradlew -p mobile :composeApp:compileKotlinAndroid

    If there are dependency conflicts, add exclusions as needed in build.gradle.kts.
  </action>
  <verify>./mobile/gradlew -p mobile :composeApp:compileKotlinAndroid --quiet && echo "BUILD SUCCESS"</verify>
  <done>Project builds successfully with MapLibre Compose integration</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `./mobile/gradlew -p mobile :composeApp:compileKotlinAndroid` succeeds
- [ ] MapLibre Compose dependencies in libs.versions.toml and build.gradle.kts
- [ ] style.json exists in composeResources/files/maps/
- [ ] MapScreen.kt, MapViewModel.kt, MapUiState.kt all exist and compile
- [ ] MapViewModel registered in Koin PresentationModule
</verification>

<success_criteria>

- All tasks completed
- Android build compiles without errors
- MapLibre Compose dependencies properly integrated
- Map infrastructure ready for navigation integration in Plan 02
- User notified about PMTiles file requirement (user_setup)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-basic-map/01-01-SUMMARY.md`
</output>
