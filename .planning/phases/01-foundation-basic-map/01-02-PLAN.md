---
phase: 01-foundation-basic-map
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/navigation/NavigationDestination.kt
  - mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/App.kt
  - mobile/composeApp/src/commonMain/composeResources/values/strings.xml
autonomous: false

must_haves:
  truths:
    - "Map tab appears in bottom navigation between Projects and Directions"
    - "Tapping Map tab displays the MapScreen"
    - "User can switch between all four tabs (Projects, Map, Directions, About)"
    - "Map is interactive - user can pan by dragging"
    - "Map supports pinch-to-zoom gesture"
    - "Map supports double-tap to zoom in"
    - "Map state is preserved when switching between tabs"
  artifacts:
    - path: "mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/navigation/NavigationDestination.kt"
      provides: "Map navigation destination"
      contains: "Map.*route.*map"
    - path: "mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/App.kt"
      provides: "Map route in NavHost"
      contains: "composable.*map.*MapScreen"
  key_links:
    - from: "NavigationDestination.kt"
      to: "App.kt"
      via: "NavigationDestination.Map usage"
      pattern: "NavigationDestination\\.Map"
    - from: "App.kt"
      to: "MapScreen.kt"
      via: "NavHost composable"
      pattern: "MapScreen"
---

<objective>
Integrate MapScreen into app navigation and verify all Phase 1 requirements.

Purpose: Complete the user-facing map feature by adding the Map tab to navigation and ensuring all gesture interactions work correctly.
Output: Working Map tab with interactive offline map satisfying MAP-01 through MAP-04 and NAV-01, NAV-02.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-basic-map/01-01-SUMMARY.md

@mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/navigation/NavigationDestination.kt
@mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/App.kt
@mobile/composeApp/src/commonMain/composeResources/values/strings.xml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Map string resources</name>
  <files>mobile/composeApp/src/commonMain/composeResources/values/strings.xml</files>
  <action>
    Add string resources for the Map tab following existing patterns.

    Add to strings.xml:
    ```xml
    <string name="map_tab_title">Map</string>
    <string name="map_tab_content_description">View map of event area</string>
    <string name="map_loading">Loading map...</string>
    <string name="map_error">Unable to load map</string>
    ```

    IMPORTANT: Use stringResource() in composables, never hardcode strings (per CONVENTIONS.md).
  </action>
  <verify>grep -q "map_tab_title" mobile/composeApp/src/commonMain/composeResources/values/strings.xml</verify>
  <done>Map string resources added</done>
</task>

<task type="auto">
  <name>Task 2: Add Map destination to NavigationDestination</name>
  <files>mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/navigation/NavigationDestination.kt</files>
  <action>
    Add a new Map destination to the NavigationDestination sealed class.

    Position: Map should appear BETWEEN Projects and Directions (as specified in ROADMAP.md success criteria).

    Current order: Projects, Directions, About
    New order: Projects, Map, Directions, About

    Add the Map object:
    ```kotlin
    data object Map : NavigationDestination(
        route = "map",
        title = "Map",  // Will be replaced with stringResource in BottomNavigationBar
        contentDescription = "View map of event area",
        icon = Icons.Default.Map  // or Icons.Default.Place or appropriate map icon
    )
    ```

    Update the `allDestinations` list to include Map in the correct position:
    ```kotlin
    val allDestinations = listOf(Projects, Map, Directions, About)
    ```

    IMPORTANT: The order in allDestinations determines tab order in BottomNavigationBar.
  </action>
  <verify>grep -q 'route = "map"' mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/navigation/NavigationDestination.kt</verify>
  <done>Map destination added to NavigationDestination with correct position</done>
</task>

<task type="auto">
  <name>Task 3: Add Map route to NavHost in App.kt</name>
  <files>mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/App.kt</files>
  <action>
    Add the Map composable route to the NavHost.

    Add import:
    ```kotlin
    import io.asterixorobelix.afrikaburn.ui.screens.map.MapScreen
    ```

    In the NavHost block, add the map route (position doesn't matter for NavHost, only for destination list):
    ```kotlin
    composable(NavigationDestination.Map.route) {
        MapScreen()
    }
    ```

    The BottomNavigationBar already iterates over NavigationDestination.allDestinations, so adding Map to that list (Task 2) automatically adds the tab button. This task just wires up the route.
  </action>
  <verify>grep -q "MapScreen" mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/App.kt</verify>
  <done>Map route added to NavHost</done>
</task>

<task type="auto">
  <name>Task 4: Verify build and run Android app</name>
  <files></files>
  <action>
    Build and verify the app compiles with navigation changes.

    1. Run: ./mobile/gradlew -p mobile :composeApp:compileKotlinAndroid
    2. Verify no compilation errors

    If using Android Studio/emulator:
    - Run the app
    - Verify Map tab appears in bottom navigation
    - Verify tap navigates to MapScreen
  </action>
  <verify>./mobile/gradlew -p mobile :composeApp:compileKotlinAndroid --quiet && echo "BUILD SUCCESS"</verify>
  <done>App builds successfully with Map navigation</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Map tab integrated into bottom navigation with interactive map display</what-built>
  <how-to-verify>
    1. Run the app on Android emulator or device:
       ```
       ./mobile/gradlew -p mobile :composeApp:installDebug
       ```
       Or run from Android Studio

    2. Verify NAV-01 and NAV-02:
       - Map tab visible in bottom navigation (between Projects and Directions)
       - Can switch between all 4 tabs: Projects, Map, Directions, About
       - Each tab displays its respective screen

    3. Verify MAP-01 (Offline map tiles):
       - Map screen shows a map (may be blank if PMTiles not yet bundled)
       - If PMTiles bundled: terrain visible for Tankwa Karoo region
       - Enable airplane mode and verify map still renders

    4. Verify MAP-02 (Pan by dragging):
       - Touch and drag on map
       - Map should pan smoothly following finger

    5. Verify MAP-03 (Pinch-to-zoom):
       - Use two fingers to pinch in/out
       - Map should zoom accordingly

    6. Verify MAP-04 (Double-tap zoom):
       - Double-tap on map
       - Map should zoom in at tap location

    7. Verify state preservation:
       - Pan/zoom to a specific location
       - Switch to another tab (e.g., Projects)
       - Switch back to Map
       - Map should show the same position/zoom level

    NOTE: If PMTiles file is not bundled yet, the map may appear blank but gestures should still work. The key test is that:
    - Navigation works
    - Gestures respond (even on blank map)
    - No crashes occur
  </how-to-verify>
  <resume-signal>Type "approved" if all navigation and gesture requirements work, or describe specific issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `./mobile/gradlew -p mobile :composeApp:compileKotlinAndroid` succeeds
- [ ] Map tab visible in bottom navigation at correct position
- [ ] All 4 tabs navigable (Projects, Map, Directions, About)
- [ ] Map gestures verified: pan, pinch-zoom, double-tap zoom
- [ ] Map state preserved when switching tabs
- [ ] User approved visual/functional verification
</verification>

<success_criteria>

- All tasks completed
- Human verification checkpoint passed
- Requirements satisfied:
  - MAP-01: Offline map tiles visible (or infrastructure ready for tiles)
  - MAP-02: Pan by dragging works
  - MAP-03: Pinch-to-zoom works
  - MAP-04: Double-tap zoom works
  - NAV-01: Map tab in bottom navigation
  - NAV-02: Can switch between all tabs
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-basic-map/01-02-SUMMARY.md`
</output>
