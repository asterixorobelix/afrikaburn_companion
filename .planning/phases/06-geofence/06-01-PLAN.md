---
phase: 06-geofence
plan: 01
type: tdd
wave: 1
depends_on: ["05-01"]
files_modified:
  - mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/domain/util/DistanceCalculator.kt
  - mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/domain/service/GeofenceService.kt
  - mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/di/DomainModule.kt
  - mobile/composeApp/src/commonTest/kotlin/io/asterixorobelix/afrikaburn/domain/util/DistanceCalculatorTest.kt
  - mobile/composeApp/src/commonTest/kotlin/io/asterixorobelix/afrikaburn/domain/service/GeofenceServiceTest.kt
autonomous: true
user_setup: []

must_haves:
  truths:
    - "App can calculate distance between two GPS coordinates in kilometers"
    - "App returns true when user is within 20km of event center"
    - "App returns false when user is outside 20km of event center"
    - "App handles null location gracefully (returns false)"
  artifacts:
    - path: "mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/domain/util/DistanceCalculator.kt"
      provides: "Haversine distance calculation utility"
      min_lines: 20
      contains: "calculateDistanceKm"
    - path: "mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/domain/service/GeofenceService.kt"
      provides: "Geofence detection service interface and implementation"
      exports: ["GeofenceService", "GeofenceServiceImpl"]
      min_lines: 30
    - path: "mobile/composeApp/src/commonTest/kotlin/io/asterixorobelix/afrikaburn/domain/util/DistanceCalculatorTest.kt"
      provides: "Unit tests for distance calculation"
      min_lines: 40
    - path: "mobile/composeApp/src/commonTest/kotlin/io/asterixorobelix/afrikaburn/domain/service/GeofenceServiceTest.kt"
      provides: "Unit tests for geofence service"
      min_lines: 60
  key_links:
    - from: "mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/domain/service/GeofenceService.kt"
      to: "DistanceCalculator"
      via: "Uses distance utility for calculations"
      pattern: "DistanceCalculator\\."
    - from: "mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/domain/service/GeofenceService.kt"
      to: "EventConfig"
      via: "Gets event coordinates from EventDateService"
      pattern: "eventDateService\\.getEventConfig"
    - from: "mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/di/DomainModule.kt"
      to: "GeofenceService"
      via: "DI registration"
      pattern: "GeofenceService"
---

<objective>
Implement geofence detection to determine if user is within 20km of AfrikaBurn event location.

Purpose: Enable Phase 7 to use geofence status as one of the unlock conditions for hidden tabs.
Output: GeofenceService with distance calculation, unit tests, and Koin DI registration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-event-config/05-01-SUMMARY.md

# Phase 5 provides EventConfig with coordinates:
@mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/domain/model/EventConfig.kt
@mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/domain/service/EventDateService.kt

# LocationService provides user GPS:
@mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/platform/LocationService.kt

# Existing Haversine pattern to extract (from MapViewModel):
@mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/presentation/map/MapViewModel.kt

# DI module to update:
@mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/di/DomainModule.kt

# Test patterns from Phase 5:
@mobile/composeApp/src/commonTest/kotlin/io/asterixorobelix/afrikaburn/domain/service/EventDateServiceTest.kt
</context>

<feature>
  <name>Geofence Distance Calculator Service</name>
  <files>
    mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/domain/util/DistanceCalculator.kt
    mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/domain/service/GeofenceService.kt
    mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/di/DomainModule.kt
    mobile/composeApp/src/commonTest/kotlin/io/asterixorobelix/afrikaburn/domain/util/DistanceCalculatorTest.kt
    mobile/composeApp/src/commonTest/kotlin/io/asterixorobelix/afrikaburn/domain/service/GeofenceServiceTest.kt
  </files>
  <behavior>
    **DistanceCalculator:**
    - calculateDistanceKm(lat1, lon1, lat2, lon2) → Double (distance in km)
    - Known test cases using real-world distances:
      - Cape Town to Johannesburg: ~1,269 km
      - Event center to 19km away: should return ~19.0 km
      - Same point to itself: should return 0.0 km

    **GeofenceService:**
    - isUserWithinGeofence(userLat, userLon) → Boolean
      - Returns true if distance from user to event center <= geofenceRadiusKm
      - Returns false if distance > geofenceRadiusKm
    - isUserWithinGeofence(locationData: LocationData?) → Boolean
      - Returns false if locationData is null
      - Returns false if location permission denied (no location data)
    - getDistanceToEventKm(userLat, userLon) → Double
      - Returns exact distance for UI display purposes

    **Test cases for GeofenceService:**
    1. User at event center → true (0 km away)
    2. User 10km from event → true (within 20km)
    3. User 19.9km from event → true (just inside boundary)
    4. User 20.0km from event → true (exactly on boundary, inclusive)
    5. User 20.1km from event → false (just outside boundary)
    6. User 50km from event → false (well outside)
    7. User in Cape Town (~400km away) → false
    8. Null location data → false (graceful handling)
    9. getDistanceToEventKm returns accurate distance
  </behavior>
  <implementation>
    1. Create DistanceCalculator object in domain/util/ with Haversine formula
       - Extract pattern from MapViewModel's isNearLocation()
       - Convert to return kilometers instead of boolean
       - Use EARTH_RADIUS_KM = 6371.0

    2. Create GeofenceService interface in domain/service/
       - isUserWithinGeofence(latitude: Double, longitude: Double): Boolean
       - isUserWithinGeofence(location: LocationData?): Boolean (convenience overload)
       - getDistanceToEventKm(latitude: Double, longitude: Double): Double

    3. Create GeofenceServiceImpl that:
       - Takes EventDateService as constructor parameter (to get EventConfig)
       - Uses DistanceCalculator for distance math
       - Compares distance to config.geofenceRadiusKm

    4. Register GeofenceService in DomainModule with Koin

    **Note:** Do NOT refactor MapViewModel to use DistanceCalculator in this phase.
    That would be scope creep. MapViewModel can continue using its private method.
    Future refactoring is a separate concern.
  </implementation>
</feature>

<verification>
TDD cycle verification:
- [ ] RED: DistanceCalculator tests written and fail (compilation error)
- [ ] GREEN: DistanceCalculator implemented, tests pass
- [ ] RED: GeofenceService tests written and fail (compilation error)
- [ ] GREEN: GeofenceService implemented, tests pass
- [ ] REFACTOR: Register in Koin, verify all tests still pass
- [ ] `./mobile/gradlew -p mobile :composeApp:testDebugUnitTest` passes
- [ ] `./mobile/gradlew -p mobile detekt` passes
</verification>

<success_criteria>
- All TDD tests pass (DistanceCalculator + GeofenceService)
- Distance calculation accuracy within 0.5% for real-world distances
- GeofenceService correctly returns true/false for within/outside 20km
- Null location handling works gracefully (returns false)
- Koin DI registration complete
- No detekt violations
- Requirement SURP-03 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/06-geofence/06-01-SUMMARY.md`
</output>
