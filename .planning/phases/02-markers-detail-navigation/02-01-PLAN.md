---
phase: 02-markers-detail-navigation
plan: 01
type: execute
wave: 1
depends_on: ["01-02"]
files_modified:
  - mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/models/ProjectItem.kt
  - mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/presentation/map/MapUiState.kt
  - mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/presentation/map/MapViewModel.kt
  - mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/ui/screens/map/MapScreen.kt
  - mobile/composeApp/src/commonMain/composeResources/files/maps/mock-locations.geojson
  - mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/App.kt
autonomous: false

must_haves:
  truths:
    - "User can see camp markers on the map with distinct purple color"
    - "User can see artwork markers on the map with distinct teal color"
    - "User can visually distinguish camp markers from artwork markers"
    - "User can tap a camp marker to open project detail screen"
    - "User can tap an artwork marker to open project detail screen"
    - "User can navigate back from detail screen to map"
  artifacts:
    - path: "mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/models/ProjectItem.kt"
      provides: "ProjectItem with optional latitude/longitude coordinates"
      contains: "latitude"
    - path: "mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/presentation/map/MapUiState.kt"
      provides: "MapUiState.Success with projects list"
      contains: "projects"
    - path: "mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/presentation/map/MapViewModel.kt"
      provides: "ViewModel with marker tap handling"
      contains: "onMarkerTapped"
    - path: "mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/ui/screens/map/MapScreen.kt"
      provides: "MapScreen with clickable markers"
      contains: "onMapClick"
  key_links:
    - from: "MapScreen.kt"
      to: "onMarkerTapped callback"
      via: "onMapClick with feature query"
      pattern: "onMapClick.*queryRenderedFeatures"
    - from: "App.kt"
      to: "ProjectDetailScreen"
      via: "navigation from map"
      pattern: "onProjectClick"
---

<objective>
Implement tappable camp and artwork markers that navigate to project detail screens.

Purpose: Allow users to discover and learn about camps and artworks directly from the map by tapping markers.
Output: Interactive markers with distinct visual styling (purple camps, teal artworks) that navigate to existing ProjectDetailScreen when tapped.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-basic-map/01-02-SUMMARY.md

# Key source files:
@mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/models/ProjectItem.kt
@mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/presentation/map/MapUiState.kt
@mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/presentation/map/MapViewModel.kt
@mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/ui/screens/map/MapScreen.kt
@mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/App.kt
@mobile/composeApp/src/commonMain/composeResources/files/maps/mock-locations.geojson
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add coordinate fields to ProjectItem model</name>
  <files>mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/models/ProjectItem.kt</files>
  <action>
Add optional latitude and longitude fields to ProjectItem data class:
- Add `@SerialName("latitude") val latitude: Double? = null`
- Add `@SerialName("longitude") val longitude: Double? = null`
- Add computed property `val hasCoordinates: Boolean get() = latitude != null && longitude != null`

These fields are nullable because actual JSON data files (WTFThemeCamps.json, WTFArtworks.json) don't have coordinates yet. The mock-locations.geojson provides coordinates separately for now.

Keep existing computed properties (isFamilyFriendly, isDaytime, isNighttime, matchesTimeFilter).
  </action>
  <verify>Build compiles: `./mobile/gradlew -p mobile :composeApp:compileCommonMainKotlinMetadata`</verify>
  <done>ProjectItem has latitude, longitude, and hasCoordinates members</done>
</task>

<task type="auto">
  <name>Task 2: Update mock-locations.geojson with project codes</name>
  <files>mobile/composeApp/src/commonMain/composeResources/files/maps/mock-locations.geojson</files>
  <action>
Update each feature in the GeoJSON to include a unique "code" property that can be used to match with ProjectItem data:
- For camp features: add "code" matching the camp's code from WTFThemeCamps.json (e.g., "vag" for The Vagabonds)
- For artwork features: add "code" matching the artwork's code from WTFArtworks.json (e.g., "bc" for Bee Cool Build)

Example feature structure:
```json
{
  "type": "Feature",
  "properties": {
    "name": "The Vagabonds",
    "type": "camp",
    "code": "vag",
    "description": "Wellness and relaxation camp"
  },
  "geometry": { "type": "Point", "coordinates": [19.8960, -32.4805] }
}
```

This code property enables matching tapped markers to ProjectItem instances loaded from JSON.
  </action>
  <verify>JSON is valid: `cat mobile/composeApp/src/commonMain/composeResources/files/maps/mock-locations.geojson | python3 -m json.tool > /dev/null && echo "Valid JSON"`</verify>
  <done>All GeoJSON features have code property matching project codes</done>
</task>

<task type="auto">
  <name>Task 3: Extend MapUiState with projects list</name>
  <files>mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/presentation/map/MapUiState.kt</files>
  <action>
Update MapUiState.Success to include a list of projects for marker tap matching:
- Add `val projects: List<ProjectItem> = emptyList()` parameter to Success data class
- Keep existing camera position parameters (centerLatitude, centerLongitude, zoomLevel)

This allows the map screen to look up project details when a marker is tapped by matching the feature's "code" property.
  </action>
  <verify>Build compiles: `./mobile/gradlew -p mobile :composeApp:compileCommonMainKotlinMetadata`</verify>
  <done>MapUiState.Success has projects list</done>
</task>

<task type="auto">
  <name>Task 4: Enhance MapViewModel with project loading and tap handling</name>
  <files>mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/presentation/map/MapViewModel.kt</files>
  <action>
Enhance MapViewModel to:

1. Load camp and artwork data on init from JSON resources (reuse existing TabDataSource pattern)
2. Expose callback for marker taps that returns ProjectItem

Add these members:
- Private mutable state for loaded projects
- Init block that loads projects from WTFThemeCamps.json and WTFArtworks.json
- Method `findProjectByCode(code: String): ProjectItem?` to match tapped feature code
- Update Success state emission to include loaded projects

Use existing resource loading pattern from ProjectsScreen/TabDataSource:
```kotlin
private suspend fun loadProjects(): List<ProjectItem> {
    val json = Json { ignoreUnknownKeys = true; isLenient = true }
    val camps = Res.readBytes("files/WTFThemeCamps.json").decodeToString()
        .let { json.decodeFromString<List<ProjectItem>>(it) }
    val artworks = Res.readBytes("files/WTFArtworks.json").decodeToString()
        .let { json.decodeFromString<List<ProjectItem>>(it) }
    return camps + artworks
}
```

Launch this in init with viewModelScope.
  </action>
  <verify>Build compiles: `./mobile/gradlew -p mobile :composeApp:compileCommonMainKotlinMetadata`</verify>
  <done>MapViewModel loads projects and can match codes to ProjectItem</done>
</task>

<task type="auto">
  <name>Task 5: Add marker tap handling to MapScreen</name>
  <files>mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/ui/screens/map/MapScreen.kt</files>
  <action>
Update MapScreen to handle marker taps using MapLibre Compose's onMapClick API:

1. Add onProjectClick parameter to MapScreen: `onProjectClick: (ProjectItem) -> Unit`
2. Update MapContent to accept this callback and projects list
3. Add onMapClick to MaplibreMap that:
   - Uses cameraState.projection?.queryRenderedFeatures(offset) to find tapped features
   - Filters for features from "camp-markers" or "artwork-markers" layers
   - Extracts the "code" property from the tapped feature
   - Looks up the corresponding ProjectItem using viewModel.findProjectByCode()
   - If found, calls onProjectClick(project) and returns ClickResult.Consume
   - If not found, returns ClickResult.Pass

Import required MapLibre click types:
```kotlin
import org.maplibre.compose.map.ClickResult
```

Example pattern:
```kotlin
MaplibreMap(
    modifier = Modifier.fillMaxSize(),
    baseStyle = BaseStyle.Uri(Res.getUri(MAP_STYLE_PATH)),
    cameraState = cameraState,
    onMapClick = { pos, offset ->
        val features = cameraState.projection?.queryRenderedFeatures(offset)
        val markerFeature = features?.firstOrNull { feature ->
            val type = feature.properties?.get("type")?.toString()?.removeSurrounding("\"")
            type == "camp" || type == "artwork"
        }
        if (markerFeature != null) {
            val code = markerFeature.properties?.get("code")?.toString()?.removeSurrounding("\"")
            code?.let { viewModel.findProjectByCode(it) }?.let { project ->
                onProjectClick(project)
                return@MaplibreMap ClickResult.Consume
            }
        }
        ClickResult.Pass
    }
)
```
  </action>
  <verify>Build compiles: `./mobile/gradlew -p mobile :composeApp:compileCommonMainKotlinMetadata`</verify>
  <done>MapScreen handles marker taps and calls onProjectClick</done>
</task>

<task type="auto">
  <name>Task 6: Wire MapScreen to navigation in App.kt</name>
  <files>mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/App.kt</files>
  <action>
Update the Map route composable in App.kt to pass onProjectClick callback:

Replace:
```kotlin
composable(NavigationDestination.Map.route) {
    MapScreen()
}
```

With:
```kotlin
composable(NavigationDestination.Map.route) {
    MapScreen(
        onProjectClick = { project ->
            selectedProject = project
            navController.navigate(PROJECT_DETAIL_ROUTE)
        }
    )
}
```

This reuses the existing selectedProject state and navigation pattern already used for ProjectsScreen.
  </action>
  <verify>Build compiles: `./mobile/gradlew -p mobile :composeApp:compileCommonMainKotlinMetadata`</verify>
  <done>Map marker taps navigate to project detail screen</done>
</task>

<task type="auto">
  <name>Task 7: Run full build and tests</name>
  <files>N/A</files>
  <action>
Run full build to verify all changes compile together:
1. Run `./mobile/gradlew -p mobile build`
2. Run `./mobile/gradlew -p mobile detekt` for code quality
3. Fix any compilation errors or detekt issues

Common issues to watch for:
- Import statements for ClickResult, Feature properties
- Nullable handling for projection?.queryRenderedFeatures()
- JSON property extraction from GeoJSON features
  </action>
  <verify>Build succeeds with no errors: `./mobile/gradlew -p mobile build`</verify>
  <done>All code compiles and passes detekt</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Interactive camp and artwork markers that navigate to project detail screens when tapped</what-built>
  <how-to-verify>
    1. Run the app: `./mobile/gradlew -p mobile :composeApp:installDebug`
    2. Navigate to Map tab
    3. Verify: Camp markers visible (purple circles)
    4. Verify: Artwork markers visible (teal circles)
    5. Tap a camp marker (purple) - should navigate to ProjectDetailScreen with camp details
    6. Press back - should return to Map
    7. Tap an artwork marker (teal) - should navigate to ProjectDetailScreen with artwork details
    8. Press back - should return to Map
    9. Verify: Map position is preserved after returning from detail
    10. Verify: Tapping on empty map area does nothing
  </how-to-verify>
  <resume-signal>Type "approved" if all markers are tappable and navigation works, or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `./mobile/gradlew -p mobile build` succeeds
- [ ] `./mobile/gradlew -p mobile detekt` passes
- [ ] Camp markers (purple) are tappable and navigate to detail
- [ ] Artwork markers (teal) are tappable and navigate to detail
- [ ] Back navigation returns to map
- [ ] Map position preserved after detail navigation
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- MARK-01: User sees camp locations displayed as markers with distinct icon (purple circles)
- MARK-02: User sees artwork locations displayed as markers with distinct icon (teal circles)
- MARK-03: User can tap a camp marker to view camp details
- MARK-04: User can tap an artwork marker to view artwork details
- MARK-05: User can visually distinguish camp markers from artwork markers
</success_criteria>

<output>
After completion, create `.planning/phases/02-markers-detail-navigation/02-01-SUMMARY.md`
</output>
