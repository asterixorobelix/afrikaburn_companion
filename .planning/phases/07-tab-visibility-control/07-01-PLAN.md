---
phase: 07-tab-visibility-control
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - mobile/composeApp/src/commonMain/sqldelight/io/asterixorobelix/afrikaburn/UnlockState.sq
  - mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/domain/repository/UnlockStateRepository.kt
  - mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/data/repository/UnlockStateRepositoryImpl.kt
  - mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/domain/service/UnlockConditionManager.kt
  - mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/di/DatabaseModule.kt
  - mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/di/DomainModule.kt
  - mobile/composeApp/src/commonTest/kotlin/io/asterixorobelix/afrikaburn/domain/service/UnlockConditionManagerTest.kt
autonomous: true

must_haves:
  truths:
    - "App persists unlock state once triggered"
    - "Unlock evaluates date OR geofence condition"
    - "Bypass flag unlocks immediately without persistence"
    - "Once unlocked, always returns unlocked regardless of conditions"
  artifacts:
    - path: "mobile/composeApp/src/commonMain/sqldelight/io/asterixorobelix/afrikaburn/UnlockState.sq"
      provides: "SQLDelight schema for permanent unlock state"
      contains: "CREATE TABLE UnlockState"
    - path: "mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/domain/service/UnlockConditionManager.kt"
      provides: "Unlock logic combining date, geofence, and persistence"
      exports: ["UnlockConditionManager", "UnlockConditionManagerImpl"]
    - path: "mobile/composeApp/src/commonTest/kotlin/io/asterixorobelix/afrikaburn/domain/service/UnlockConditionManagerTest.kt"
      provides: "Comprehensive TDD tests for unlock logic"
      min_lines: 100
  key_links:
    - from: "UnlockConditionManager"
      to: "EventDateService"
      via: "isEventStarted() check"
      pattern: "eventDateService\\.isEventStarted"
    - from: "UnlockConditionManager"
      to: "GeofenceService"
      via: "isUserWithinGeofence() check"
      pattern: "geofenceService\\.isUserWithinGeofence"
    - from: "UnlockConditionManager"
      to: "UnlockStateRepository"
      via: "persistence layer"
      pattern: "unlockStateRepository"
---

<objective>
Create UnlockConditionManager service that evaluates date/geofence conditions and persists unlock state.

Purpose: Central service to determine if Map and Projects tabs should be visible.
Output: UnlockConditionManager with SQLDelight persistence and comprehensive TDD tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries needed for this plan:
@.planning/phases/05-event-config/05-01-SUMMARY.md
@.planning/phases/06-geofence/06-01-SUMMARY.md

# Existing services this plan integrates with:
@mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/domain/service/EventDateService.kt
@mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/domain/service/GeofenceService.kt
@mobile/composeApp/src/commonMain/sqldelight/io/asterixorobelix/afrikaburn/UserCampPin.sq
@mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/di/DatabaseModule.kt
@mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/di/DomainModule.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SQLDelight schema for unlock state</name>
  <files>mobile/composeApp/src/commonMain/sqldelight/io/asterixorobelix/afrikaburn/UnlockState.sq</files>
  <action>
Create SQLDelight schema for permanent unlock state persistence:
- Table: UnlockState with id (INTEGER PRIMARY KEY), unlockedAt (INTEGER for epoch timestamp)
- Query: getUnlockState - SELECT * FROM UnlockState LIMIT 1
- Query: setUnlocked - INSERT OR REPLACE INTO UnlockState (id, unlockedAt) VALUES (1, ?)
- Query: isUnlocked - SELECT COUNT(*) > 0 FROM UnlockState WHERE id = 1
- Only one row ever exists (id = 1), similar to UserCampPin pattern

Follow the existing UserCampPin.sq pattern for consistency.
  </action>
  <verify>./mobile/gradlew -p mobile :composeApp:generateCommonMainAfrikaBurnDatabaseInterface</verify>
  <done>UnlockState.sq compiles and generates Kotlin interfaces</done>
</task>

<task type="auto">
  <name>Task 2: Create UnlockStateRepository interface and implementation</name>
  <files>
mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/domain/repository/UnlockStateRepository.kt,
mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/data/repository/UnlockStateRepositoryImpl.kt,
mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/di/DatabaseModule.kt
  </files>
  <action>
Create repository layer for unlock state:

1. UnlockStateRepository interface (domain layer):
   - fun isUnlocked(): Boolean
   - fun setUnlocked()
   - fun getUnlockedAt(): kotlinx.datetime.Instant?

2. UnlockStateRepositoryImpl (data layer):
   - Inject AfrikaBurnDatabase
   - Implement using generated SQLDelight queries
   - Convert epoch timestamp to/from Instant

3. Register UnlockStateRepository in DatabaseModule.kt:
   - single<UnlockStateRepository> { UnlockStateRepositoryImpl(get()) }

Follow existing UserCampPinRepository pattern for consistency.
  </action>
  <verify>./mobile/gradlew -p mobile :composeApp:compileCommonMainKotlinMetadata</verify>
  <done>Repository compiles and is registered in Koin</done>
</task>

<task type="auto">
  <name>Task 3: Create UnlockConditionManager with TDD tests</name>
  <files>
mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/domain/service/UnlockConditionManager.kt,
mobile/composeApp/src/commonTest/kotlin/io/asterixorobelix/afrikaburn/domain/service/UnlockConditionManagerTest.kt,
mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/di/DomainModule.kt
  </files>
  <action>
Create UnlockConditionManager following TDD:

**RED PHASE - Write failing tests first:**
Create UnlockConditionManagerTest with these test cases:
1. isUnlocked returns true when already persisted as unlocked
2. isUnlocked returns true when eventDateService.isEventStarted() is true (and persists)
3. isUnlocked returns true when geofenceService.isUserWithinGeofence(location) is true (and persists)
4. isUnlocked returns false when no conditions met and not persisted
5. isUnlocked returns true when eventDateService.isUnlockBypassed() is true (does NOT persist)
6. Once unlocked, always returns true even if conditions change
7. checkAndUpdateUnlockState(location) evaluates conditions and persists if met
8. getUnlockedAt returns null when not unlocked, returns timestamp when unlocked

Use mock/fake implementations:
- FakeUnlockStateRepository (in-memory boolean flag)
- FakeEventDateService (controllable isEventStarted, isUnlockBypassed)
- FakeGeofenceService (controllable isUserWithinGeofence)

**GREEN PHASE - Implement to pass tests:**
UnlockConditionManager interface:
- fun isUnlocked(location: LocationData?): Boolean
- fun checkAndUpdateUnlockState(location: LocationData?)
- fun getUnlockedAt(): Instant?

UnlockConditionManagerImpl:
- Inject EventDateService, GeofenceService, UnlockStateRepository
- Logic order:
  1. If bypass enabled, return true (no persist)
  2. If already persisted unlocked, return true
  3. If eventDateService.isEventStarted() OR geofenceService.isUserWithinGeofence(location), persist and return true
  4. Otherwise return false

**REFACTOR - Register in DI:**
Add to DomainModule.kt:
- single<UnlockConditionManager> { UnlockConditionManagerImpl(get(), get(), get()) }
  </action>
  <verify>./mobile/gradlew -p mobile :composeApp:testDebugUnitTest --tests "*UnlockConditionManagerTest*"</verify>
  <done>All 8+ tests pass, UnlockConditionManager registered in Koin</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] ./mobile/gradlew -p mobile :composeApp:testDebugUnitTest (all tests pass)
- [ ] ./mobile/gradlew -p mobile :composeApp:compileCommonMainKotlinMetadata (compiles)
- [ ] ./mobile/gradlew -p mobile detekt (no violations)
- [ ] UnlockConditionManager can be injected via Koin
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- UnlockConditionManager correctly evaluates date OR geofence conditions
- Unlock state persists permanently via SQLDelight
- Bypass flag works without persistence
- No errors or warnings introduced
</success_criteria>

<output>
After completion, create `.planning/phases/07-tab-visibility-control/07-01-SUMMARY.md`
</output>
