---
phase: 07-tab-visibility-control
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/navigation/BottomNavigationBar.kt
  - mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/navigation/NavigationDestination.kt
  - mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/App.kt
  - mobile/composeApp/src/commonMain/composeResources/values/strings.xml
autonomous: false

must_haves:
  truths:
    - "Map and Projects tabs are hidden when app is locked"
    - "Tabs become visible when unlock conditions are met on app start"
    - "Welcome toast appears on first unlock"
    - "Navigation works correctly with reduced tab set"
    - "Start destination changes based on unlock state (Directions when locked, Projects when unlocked)"
  artifacts:
    - path: "mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/App.kt"
      provides: "App composition with unlock state and conditional navigation"
      contains: "UnlockConditionManager"
    - path: "mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/navigation/BottomNavigationBar.kt"
      provides: "Bottom nav that accepts filtered destinations list"
      contains: "destinations: List<NavigationDestination>"
    - path: "mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/navigation/NavigationDestination.kt"
      provides: "Function to get visible destinations based on unlock state"
      contains: "getVisibleDestinations"
  key_links:
    - from: "App.kt"
      to: "UnlockConditionManager"
      via: "Koin injection"
      pattern: "koinInject<UnlockConditionManager>"
    - from: "App.kt"
      to: "BottomNavigationBar"
      via: "filtered destinations parameter"
      pattern: "visibleDestinations"
    - from: "NavigationDestination"
      to: "allDestinations"
      via: "filtering function"
      pattern: "getVisibleDestinations"
---

<objective>
Integrate UnlockConditionManager with navigation to conditionally show/hide Map and Projects tabs.

Purpose: Complete the surprise mode feature by connecting unlock logic to the UI.
Output: Working tab visibility control with welcome message on unlock.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-tab-visibility-control/07-CONTEXT.md
@.planning/phases/07-tab-visibility-control/07-01-SUMMARY.md

# Files to modify:
@mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/App.kt
@mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/navigation/BottomNavigationBar.kt
@mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/navigation/NavigationDestination.kt

# Location service for geofence check:
@mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/platform/LocationService.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getVisibleDestinations function to NavigationDestination</name>
  <files>mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/navigation/NavigationDestination.kt</files>
  <action>
Add a companion object function to filter destinations based on unlock state:

```kotlin
companion object {
    val allDestinations: List<NavigationDestination> by lazy {
        listOf(Projects, Map, Directions, About)
    }

    /**
     * Returns destinations visible based on unlock state.
     * When locked: Only Directions and About tabs are visible.
     * When unlocked: All tabs are visible.
     */
    fun getVisibleDestinations(isUnlocked: Boolean): List<NavigationDestination> {
        return if (isUnlocked) {
            allDestinations
        } else {
            listOf(Directions, About)
        }
    }

    /**
     * Tabs that require unlock to be visible.
     */
    val lockedDestinations: Set<NavigationDestination> = setOf(Projects, Map)
}
```

This keeps the filtering logic centralized and testable.
  </action>
  <verify>./mobile/gradlew -p mobile :composeApp:compileCommonMainKotlinMetadata</verify>
  <done>getVisibleDestinations function compiles and returns correct lists</done>
</task>

<task type="auto">
  <name>Task 2: Update BottomNavigationBar to accept destinations list</name>
  <files>mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/navigation/BottomNavigationBar.kt</files>
  <action>
Modify BottomNavigationBar to accept a filtered destinations list instead of using allDestinations:

```kotlin
@Composable
fun BottomNavigationBar(
    currentRoute: String?,
    onNavigate: (String) -> Unit,
    destinations: List<NavigationDestination> = NavigationDestination.allDestinations,
    modifier: Modifier = Modifier
) {
    NavigationBar(
        modifier = modifier,
        containerColor = MaterialTheme.colorScheme.surface,
        contentColor = MaterialTheme.colorScheme.onSurface
    ) {
        destinations.forEach { destination ->
            // ... existing NavigationBarItem code
        }
    }
}
```

Default parameter maintains backward compatibility but allows filtering.
  </action>
  <verify>./mobile/gradlew -p mobile :composeApp:compileCommonMainKotlinMetadata</verify>
  <done>BottomNavigationBar accepts destinations parameter</done>
</task>

<task type="auto">
  <name>Task 3: Add welcome string resource</name>
  <files>mobile/composeApp/src/commonMain/composeResources/values/strings.xml</files>
  <action>
Add string resource for the welcome message:

```xml
<!-- Surprise Mode -->
<string name="unlock_welcome_message">Welcome to AfrikaBurn!</string>
```

This follows the project's string resource conventions.
  </action>
  <verify>./mobile/gradlew -p mobile :composeApp:generateComposeResClass</verify>
  <done>String resource generates correctly</done>
</task>

<task type="auto">
  <name>Task 4: Integrate unlock logic into App.kt</name>
  <files>mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/App.kt</files>
  <action>
Integrate UnlockConditionManager with the navigation:

1. Inject UnlockConditionManager via Koin
2. Get user location from LocationService (if available)
3. Check unlock state on app start
4. Pass filtered destinations to BottomNavigationBar
5. Show Snackbar when first unlocked
6. Change startDestination based on unlock state

Key implementation points:

```kotlin
// Inject services
val unlockManager: UnlockConditionManager = koinInject()
val locationService: LocationService = koinInject()

// Get current location (may be null)
var currentLocation by remember { mutableStateOf<LocationData?>(null) }

// Track if we showed welcome message this session
var hasShownWelcome by rememberSaveable { mutableStateOf(false) }

// Check unlock state
LaunchedEffect(Unit) {
    // Try to get location for geofence check
    if (locationService.hasPermission()) {
        locationService.getCurrentLocation { location ->
            currentLocation = location
        }
    }
}

// Evaluate unlock with current location
val isUnlocked = unlockManager.isUnlocked(currentLocation)
val visibleDestinations = NavigationDestination.getVisibleDestinations(isUnlocked)

// Determine start destination
val startDestination = if (isUnlocked) {
    NavigationDestination.Projects.route
} else {
    NavigationDestination.Directions.route
}

// Show welcome message on first unlock (once per session, after location determined)
val snackbarHostState = remember { SnackbarHostState() }
val welcomeMessage = stringResource(Res.string.unlock_welcome_message)
LaunchedEffect(isUnlocked, hasShownWelcome) {
    if (isUnlocked && !hasShownWelcome && unlockManager.getUnlockedAt() != null) {
        // Only show if this was a real unlock (not bypass)
        snackbarHostState.showSnackbar(welcomeMessage)
        hasShownWelcome = true
    }
}

// Pass to BottomNavigationBar
BottomNavigationBar(
    currentRoute = currentRoute,
    onNavigate = { ... },
    destinations = visibleDestinations
)
```

Add SnackbarHost to Scaffold for welcome message display.

IMPORTANT: Handle the case where location permission is not granted - date unlock should still work.
  </action>
  <verify>./mobile/gradlew -p mobile :composeApp:compileCommonMainKotlinMetadata</verify>
  <done>App.kt compiles with unlock logic integrated</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete tab visibility control with unlock logic and welcome message</what-built>
  <how-to-verify>
    1. Run: make install (or ./mobile/gradlew -p mobile :composeApp:installDebug)
    2. Launch the app

    **Test LOCKED state:**
    3. With current date before April 27, 2026 and NOT near Tankwa Karoo:
       - Verify only 2 tabs visible: "Directions" and "About"
       - Verify "Projects" and "Map" tabs are NOT visible
       - Verify app starts on Directions tab

    **Test UNLOCKED state (date):**
    4. Modify EventConfig.DEFAULT to set eventStartDate to a past date (e.g., 2024-01-01)
    5. Rebuild and reinstall
    6. Launch app fresh (clear app data first)
    7. Verify all 4 tabs visible: "Projects", "Map", "Directions", "About"
    8. Verify "Welcome to AfrikaBurn!" snackbar appears
    9. Verify app starts on Projects tab

    **Test PERSISTENCE:**
    10. Close app completely
    11. Revert EventConfig to future date
    12. Rebuild and reinstall (WITHOUT clearing app data)
    13. Launch app - tabs should STILL be visible (unlock persisted)
    14. Welcome message should NOT appear again

    **Test BYPASS (optional, for dev testing):**
    15. In DomainModule.kt, change EventDateServiceImpl to pass bypassSurpriseMode = true
    16. Clear app data, rebuild, install
    17. Launch - all tabs should be visible immediately
    18. No welcome message (bypass doesn't persist)
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] ./mobile/gradlew -p mobile :composeApp:testDebugUnitTest (all tests pass)
- [ ] ./mobile/gradlew -p mobile :composeApp:compileCommonMainKotlinMetadata (compiles)
- [ ] ./mobile/gradlew -p mobile detekt (no violations)
- [ ] Human verification checkpoint passed
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Map and Projects tabs hidden when locked
- Tabs visible when unlocked (date or geofence)
- Welcome message appears on first unlock
- Unlock state persists across app restarts
- Navigation works correctly with reduced tab set
</success_criteria>

<output>
After completion, create `.planning/phases/07-tab-visibility-control/07-02-SUMMARY.md`
</output>
