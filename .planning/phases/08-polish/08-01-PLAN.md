---
phase: 08-polish
plan: 01
type: execute
wave: 1
depends_on: ["07-02"]
files_modified:
  - mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/App.kt
  - mobile/composeApp/src/commonTest/kotlin/io/asterixorobelix/afrikaburn/domain/service/EventDateServiceTest.kt
  - mobile/composeApp/src/commonTest/kotlin/io/asterixorobelix/afrikaburn/domain/service/UnlockConditionManagerTest.kt
autonomous: true
user_setup: []

# Goal-backward verification
must_haves:
  truths:
    - "App unlocks via date when location permission is denied"
    - "Timezone boundary cases (midnight SAST) handled correctly"
    - "Navigation updates smoothly when unlock conditions change"
    - "All unlock logic tests pass with 80%+ coverage"
  artifacts:
    - path: "mobile/composeApp/src/commonTest/kotlin/io/asterixorobelix/afrikaburn/domain/service/EventDateServiceTest.kt"
      provides: "Timezone edge case tests"
      contains: "midnight"
    - path: "mobile/composeApp/src/commonTest/kotlin/io/asterixorobelix/afrikaburn/domain/service/UnlockConditionManagerTest.kt"
      provides: "Permission denial handling tests"
      min_lines: 400
  key_links:
    - from: "App.kt"
      to: "UnlockConditionManager"
      via: "isUnlocked called regardless of permission state"
      pattern: "isUnlocked\\(.*\\)"
---

<objective>
Polish and harden the surprise mode unlock logic for production release.

Purpose: Ensure robust behavior for edge cases: permission denial (date unlock still works), timezone boundaries, and smooth navigation transitions.
Output: Additional tests validating edge cases, verified 80%+ test coverage for unlock logic.
</objective>

<execution_context>
@/Users/nathanstasin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nathanstasin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-tab-visibility-control/07-01-SUMMARY.md
@.planning/phases/07-tab-visibility-control/07-02-SUMMARY.md

# Key source files to understand current implementation:
@mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/App.kt
@mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/domain/service/UnlockConditionManager.kt
@mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/domain/service/EventDateService.kt
@mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/domain/service/GeofenceService.kt

# Existing test files to extend:
@mobile/composeApp/src/commonTest/kotlin/io/asterixorobelix/afrikaburn/domain/service/EventDateServiceTest.kt
@mobile/composeApp/src/commonTest/kotlin/io/asterixorobelix/afrikaburn/domain/service/UnlockConditionManagerTest.kt
@mobile/composeApp/src/commonTest/kotlin/io/asterixorobelix/afrikaburn/domain/service/GeofenceServiceTest.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add timezone boundary tests for EventDateService</name>
  <files>mobile/composeApp/src/commonTest/kotlin/io/asterixorobelix/afrikaburn/domain/service/EventDateServiceTest.kt</files>
  <action>
  Add tests verifying timezone handling at midnight boundaries:

  1. Test: `isEventStarted returns false at 23:59 SAST on day before event`
     - Create Instant at "2026-04-26T21:59:00Z" (23:59 SAST = 21:59 UTC on April 26)
     - Should return false

  2. Test: `isEventStarted returns true at 00:00 SAST on event start day`
     - Create Instant at "2026-04-26T22:00:00Z" (00:00 SAST April 27 = 22:00 UTC April 26)
     - Should return true

  3. Test: `isEventStarted returns true at 00:01 SAST on event start day`
     - Create Instant at "2026-04-26T22:01:00Z"
     - Should return true

  These tests verify the Africa/Johannesburg timezone (UTC+2) is correctly applied for date comparisons, especially at midnight boundaries.
  </action>
  <verify>./gradlew :composeApp:testDebugUnitTest --tests "io.asterixorobelix.afrikaburn.domain.service.EventDateServiceTest" 2>&1 | grep -E "(PASSED|FAILED|BUILD)"</verify>
  <done>All new timezone boundary tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Add permission denial edge case tests for UnlockConditionManager</name>
  <files>mobile/composeApp/src/commonTest/kotlin/io/asterixorobelix/afrikaburn/domain/service/UnlockConditionManagerTest.kt</files>
  <action>
  Add tests verifying date unlock works when location permission is denied:

  1. Test: `date unlock works when location is null (permission denied)`
     - Create manager with eventStarted = true
     - Call isUnlocked(null)
     - Should return true and persist
     - Verify this is the expected behavior for permission-denied users

  2. Test: `date unlock takes priority over null location when both conditions possible`
     - Create manager with eventStarted = true, geofence not set up
     - Call isUnlocked(null)
     - Should unlock via date, not fail due to missing location

  3. Test: `location null does not block date-based unlock persistence`
     - Create manager, trigger unlock with null location
     - Restart (new manager instance with same repository state)
     - Call isUnlocked(null) again
     - Should return true from persistence

  Note: Test 1 already partially covered by existing `null location with event started still unlocks` test, but add more explicit verification of the permission-denial scenario.
  </action>
  <verify>./gradlew :composeApp:testDebugUnitTest --tests "io.asterixorobelix.afrikaburn.domain.service.UnlockConditionManagerTest" 2>&1 | grep -E "(PASSED|FAILED|BUILD)"</verify>
  <done>All new permission denial tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Verify and document test coverage</name>
  <files>mobile/composeApp/build.gradle.kts</files>
  <action>
  Run test coverage analysis:

  1. Run: ./gradlew :composeApp:testDebugUnitTest jacocoTestReport
  2. Check coverage report in build/reports/jacoco/testDebugUnitTestCoverage/
  3. Verify unlock-related classes have 80%+ coverage:
     - EventDateService
     - EventDateServiceImpl
     - GeofenceService
     - GeofenceServiceImpl
     - UnlockConditionManager
     - UnlockConditionManagerImpl
  4. If any class is below 80%, identify missing tests and add them

  Note: This task may not require code changes if coverage is already sufficient.
  Focus on the domain/service package classes related to unlock logic.
  </action>
  <verify>./gradlew :composeApp:testDebugUnitTest 2>&1 | grep -E "(BUILD SUCCESS|BUILD FAIL)"</verify>
  <done>All tests pass, unlock logic classes verified for sufficient coverage</done>
</task>

<task type="auto">
  <name>Task 4: Run full test suite and detekt</name>
  <files>N/A</files>
  <action>
  Final validation:

  1. Run: ./gradlew :composeApp:testDebugUnitTest detekt
  2. Ensure all tests pass (expect 160+ tests)
  3. Ensure detekt reports no issues
  4. Count tests related to unlock logic:
     - EventDateServiceTest
     - GeofenceServiceTest
     - UnlockConditionManagerTest

  This verifies Phase 8 changes don't introduce regressions.
  </action>
  <verify>./gradlew :composeApp:testDebugUnitTest detekt 2>&1 | grep -E "(BUILD SUCCESS|BUILD FAIL|tests)"</verify>
  <done>Full test suite passes, detekt clean, no regressions</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All 3 timezone boundary tests pass for EventDateServiceTest
- [ ] Permission denial edge case tests pass for UnlockConditionManagerTest
- [ ] Full test suite passes (./gradlew :composeApp:testDebugUnitTest)
- [ ] Detekt analysis passes (./gradlew detekt)
- [ ] Unlock logic classes have adequate test coverage
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Timezone edge cases properly tested
- Permission denial scenario verified to work via date unlock
- Test count for unlock logic: 50+ tests across EventDateService, GeofenceService, UnlockConditionManager
</success_criteria>

<output>
After completion, create `.planning/phases/08-polish/08-01-SUMMARY.md`
</output>
