---
phase: 04-user-camp-pin
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/presentation/map/MapUiState.kt
  - mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/presentation/map/MapViewModel.kt
  - mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/di/PresentationModule.kt
  - mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/ui/screens/map/MapScreen.kt
  - mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/ui/screens/map/CampPinDialog.kt
  - mobile/composeApp/src/commonMain/composeResources/files/maps/style.json
  - mobile/composeApp/src/commonMain/composeResources/values/strings.xml
autonomous: false

must_haves:
  truths:
    - "User can long-press on map to place a camp pin"
    - "Confirmation dialog appears before pin is placed"
    - "User's camp pin appears as a distinct orange marker"
    - "Camp pin persists after closing and reopening app"
    - "User can long-press existing pin to see move/delete options"
    - "User can move pin to new location"
    - "User can delete pin"
  artifacts:
    - path: "mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/presentation/map/MapUiState.kt"
      provides: "MapUiState with userCampPin field"
      contains: "userCampPin"
    - path: "mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/presentation/map/MapViewModel.kt"
      provides: "ViewModel with camp pin operations"
      contains: "saveCampPin"
    - path: "mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/ui/screens/map/CampPinDialog.kt"
      provides: "Dialog composables for camp pin actions"
      contains: "CampPinPlaceDialog"
    - path: "mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/ui/screens/map/MapScreen.kt"
      provides: "MapScreen with long-press handling and camp pin layer"
      contains: "onMapLongClick"
  key_links:
    - from: "MapScreen.kt"
      to: "MapViewModel"
      via: "long-press triggers saveCampPin"
      pattern: "onMapLongClick.*saveCampPin"
    - from: "MapViewModel.kt"
      to: "UserCampPinRepository"
      via: "repository injection"
      pattern: "userCampPinRepository"
---

<objective>
Implement the complete camp pin UI: long-press to place, confirmation dialogs, visual marker, and move/delete functionality.

Purpose: Complete PIN-01, PIN-02, PIN-03, PIN-04 requirements by adding user-facing camp pin features to the map screen.
Output: Fully interactive camp pin feature with distinct orange marker, dialogs for placement/move/delete, and persistence.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-user-camp-pin/04-01-SUMMARY.md

# Key source files:
@mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/presentation/map/MapUiState.kt
@mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/presentation/map/MapViewModel.kt
@mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/ui/screens/map/MapScreen.kt
@mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/domain/repository/UserCampPinRepository.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add camp pin string resources</name>
  <files>mobile/composeApp/src/commonMain/composeResources/values/strings.xml</files>
  <action>
Add string resources for camp pin dialogs and UI:

```xml
<!-- Camp Pin -->
<string name="camp_pin_place_title">Place Your Camp Pin?</string>
<string name="camp_pin_place_message">Mark this location as your camp. You can move or delete it later.</string>
<string name="camp_pin_place_confirm">Place Pin</string>
<string name="camp_pin_cancel">Cancel</string>

<string name="camp_pin_options_title">Your Camp Pin</string>
<string name="camp_pin_move">Move Pin</string>
<string name="camp_pin_delete">Delete Pin</string>

<string name="camp_pin_move_title">Move Your Camp Pin?</string>
<string name="camp_pin_move_message">Move your camp pin to this new location?</string>
<string name="camp_pin_move_confirm">Move Here</string>

<string name="camp_pin_delete_title">Delete Camp Pin?</string>
<string name="camp_pin_delete_message">Are you sure you want to delete your camp pin? You can place a new one anytime by long-pressing the map.</string>
<string name="camp_pin_delete_confirm">Delete</string>

<string name="camp_pin_name_default">My Camp</string>
<string name="cd_camp_pin_marker">Your camp location</string>
```

These strings support all PIN-01 through PIN-04 interactions.
  </action>
  <verify>Strings added: `grep -c "camp_pin" mobile/composeApp/src/commonMain/composeResources/values/strings.xml`</verify>
  <done>Camp pin strings added to resources</done>
</task>

<task type="auto">
  <name>Task 2: Extend MapUiState with camp pin data</name>
  <files>mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/presentation/map/MapUiState.kt</files>
  <action>
Update MapUiState.Success to include camp pin state:

Add to Success data class:
```kotlin
// User's saved camp pin
val userCampPin: CampPinState = CampPinState.None,

// Dialog state for camp pin interactions
val campPinDialogState: CampPinDialogState = CampPinDialogState.Hidden
```

Add new state classes (can be in same file or separate):
```kotlin
/**
 * State of the user's camp pin.
 */
sealed interface CampPinState {
    /** No camp pin saved */
    data object None : CampPinState

    /** Camp pin exists at location */
    data class Placed(
        val latitude: Double,
        val longitude: Double,
        val name: String
    ) : CampPinState
}

/**
 * Dialog state for camp pin interactions.
 */
sealed interface CampPinDialogState {
    /** No dialog shown */
    data object Hidden : CampPinDialogState

    /** Confirm placing new pin at location */
    data class ConfirmPlace(
        val latitude: Double,
        val longitude: Double
    ) : CampPinDialogState

    /** Options for existing pin (move/delete) */
    data object PinOptions : CampPinDialogState

    /** Confirm moving pin to new location */
    data class ConfirmMove(
        val newLatitude: Double,
        val newLongitude: Double
    ) : CampPinDialogState

    /** Confirm deleting pin */
    data object ConfirmDelete : CampPinDialogState
}
```

These states enable the UI to react to camp pin placement, options dialogs, and move/delete confirmations.
  </action>
  <verify>File compiles: `cd /Users/nathanstasin/Documents/afrikaburn_companion/mobile && ./gradlew :composeApp:compileCommonMainKotlinMetadata 2>&1 | tail -10`</verify>
  <done>MapUiState extended with CampPinState and CampPinDialogState</done>
</task>

<task type="auto">
  <name>Task 3: Enhance MapViewModel with camp pin operations</name>
  <files>mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/presentation/map/MapViewModel.kt</files>
  <action>
Update MapViewModel to handle camp pin operations:

1. Add repository injection to constructor:
```kotlin
class MapViewModel(
    private val locationService: LocationService,
    private val userCampPinRepository: UserCampPinRepository
) : ViewModel()
```

2. Add import:
```kotlin
import io.asterixorobelix.afrikaburn.domain.repository.UserCampPinRepository
```

3. In init block, observe camp pin changes:
```kotlin
init {
    // Existing initialization...

    // Observe camp pin from database
    viewModelScope.launch {
        userCampPinRepository.observeCampPin().collect { pin ->
            val currentState = _uiState.value
            if (currentState is MapUiState.Success) {
                _uiState.value = currentState.copy(
                    userCampPin = pin?.let {
                        CampPinState.Placed(
                            latitude = it.latitude,
                            longitude = it.longitude,
                            name = it.name
                        )
                    } ?: CampPinState.None
                )
            }
        }
    }
}
```

4. Add methods for camp pin interactions:
```kotlin
/**
 * Called when user long-presses on map.
 * If no pin exists, show place confirmation.
 * If pin exists and long-press is on pin, show options.
 * If pin exists and long-press elsewhere, show move confirmation.
 */
fun onMapLongPress(latitude: Double, longitude: Double) {
    val currentState = _uiState.value
    if (currentState !is MapUiState.Success) return

    when (val pinState = currentState.userCampPin) {
        is CampPinState.None -> {
            // No pin - show place confirmation
            _uiState.value = currentState.copy(
                campPinDialogState = CampPinDialogState.ConfirmPlace(latitude, longitude)
            )
        }
        is CampPinState.Placed -> {
            // Check if long-press is near existing pin (within ~50 meters)
            val isNearPin = isNearLocation(
                lat1 = latitude, lon1 = longitude,
                lat2 = pinState.latitude, lon2 = pinState.longitude,
                thresholdMeters = 50.0
            )
            if (isNearPin) {
                // Show pin options (move/delete)
                _uiState.value = currentState.copy(
                    campPinDialogState = CampPinDialogState.PinOptions
                )
            } else {
                // Show move confirmation
                _uiState.value = currentState.copy(
                    campPinDialogState = CampPinDialogState.ConfirmMove(latitude, longitude)
                )
            }
        }
    }
}

/**
 * Dismiss any open dialog.
 */
fun dismissDialog() {
    val currentState = _uiState.value
    if (currentState is MapUiState.Success) {
        _uiState.value = currentState.copy(campPinDialogState = CampPinDialogState.Hidden)
    }
}

/**
 * Confirm placing pin at the pending location.
 */
fun confirmPlacePin() {
    val currentState = _uiState.value
    if (currentState !is MapUiState.Success) return

    val dialogState = currentState.campPinDialogState
    if (dialogState is CampPinDialogState.ConfirmPlace) {
        viewModelScope.launch {
            userCampPinRepository.saveCampPin(
                latitude = dialogState.latitude,
                longitude = dialogState.longitude
            )
        }
        _uiState.value = currentState.copy(campPinDialogState = CampPinDialogState.Hidden)
    }
}

/**
 * Show delete confirmation dialog.
 */
fun showDeleteConfirmation() {
    val currentState = _uiState.value
    if (currentState is MapUiState.Success) {
        _uiState.value = currentState.copy(campPinDialogState = CampPinDialogState.ConfirmDelete)
    }
}

/**
 * Confirm deleting the pin.
 */
fun confirmDeletePin() {
    val currentState = _uiState.value
    if (currentState is MapUiState.Success) {
        viewModelScope.launch {
            userCampPinRepository.deleteCampPin()
        }
        _uiState.value = currentState.copy(campPinDialogState = CampPinDialogState.Hidden)
    }
}

/**
 * Confirm moving pin to the pending location.
 */
fun confirmMovePin() {
    val currentState = _uiState.value
    if (currentState !is MapUiState.Success) return

    val dialogState = currentState.campPinDialogState
    if (dialogState is CampPinDialogState.ConfirmMove) {
        viewModelScope.launch {
            userCampPinRepository.updateLocation(
                latitude = dialogState.newLatitude,
                longitude = dialogState.newLongitude
            )
        }
        _uiState.value = currentState.copy(campPinDialogState = CampPinDialogState.Hidden)
    }
}

/**
 * Simple distance check using haversine approximation.
 */
private fun isNearLocation(
    lat1: Double, lon1: Double,
    lat2: Double, lon2: Double,
    thresholdMeters: Double
): Boolean {
    val earthRadius = 6371000.0 // meters
    val dLat = Math.toRadians(lat2 - lat1)
    val dLon = Math.toRadians(lon2 - lon1)
    val a = kotlin.math.sin(dLat / 2) * kotlin.math.sin(dLat / 2) +
            kotlin.math.cos(Math.toRadians(lat1)) * kotlin.math.cos(Math.toRadians(lat2)) *
            kotlin.math.sin(dLon / 2) * kotlin.math.sin(dLon / 2)
    val c = 2 * kotlin.math.atan2(kotlin.math.sqrt(a), kotlin.math.sqrt(1 - a))
    val distance = earthRadius * c
    return distance <= thresholdMeters
}
```

Note: Import kotlin.math functions as needed.
  </action>
  <verify>File compiles: `cd /Users/nathanstasin/Documents/afrikaburn_companion/mobile && ./gradlew :composeApp:compileCommonMainKotlinMetadata 2>&1 | tail -10`</verify>
  <done>MapViewModel has camp pin operations</done>
</task>

<task type="auto">
  <name>Task 4: Update PresentationModule to inject repository</name>
  <files>mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/di/PresentationModule.kt</files>
  <action>
Update MapViewModel factory in PresentationModule to include UserCampPinRepository:

Find the existing MapViewModel registration and update it:

```kotlin
factory { MapViewModel(get(), get()) }
```

This assumes the module has both LocationService and UserCampPinRepository registered. Koin will resolve both via `get()`.

If the module uses named parameters or viewModel helper:
```kotlin
viewModel { MapViewModel(get(), get()) }
```

Make sure imports include UserCampPinRepository if needed for explicit typing.
  </action>
  <verify>Repository is injected: `grep -n "MapViewModel" mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/di/PresentationModule.kt`</verify>
  <done>MapViewModel factory updated with repository injection</done>
</task>

<task type="auto">
  <name>Task 5: Create CampPinDialog composables</name>
  <files>mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/ui/screens/map/CampPinDialog.kt</files>
  <action>
Create dialog composables for camp pin interactions:

Path: `mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/ui/screens/map/CampPinDialog.kt`

```kotlin
package io.asterixorobelix.afrikaburn.ui.screens.map

import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.material3.AlertDialog
import androidx.compose.material3.Button
import androidx.compose.material3.ButtonDefaults
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.OutlinedButton
import androidx.compose.material3.Text
import androidx.compose.material3.TextButton
import androidx.compose.runtime.Composable
import androidx.compose.ui.Modifier
import afrikaburn.composeapp.generated.resources.Res
import afrikaburn.composeapp.generated.resources.camp_pin_cancel
import afrikaburn.composeapp.generated.resources.camp_pin_delete
import afrikaburn.composeapp.generated.resources.camp_pin_delete_confirm
import afrikaburn.composeapp.generated.resources.camp_pin_delete_message
import afrikaburn.composeapp.generated.resources.camp_pin_delete_title
import afrikaburn.composeapp.generated.resources.camp_pin_move
import afrikaburn.composeapp.generated.resources.camp_pin_move_confirm
import afrikaburn.composeapp.generated.resources.camp_pin_move_message
import afrikaburn.composeapp.generated.resources.camp_pin_move_title
import afrikaburn.composeapp.generated.resources.camp_pin_options_title
import afrikaburn.composeapp.generated.resources.camp_pin_place_confirm
import afrikaburn.composeapp.generated.resources.camp_pin_place_message
import afrikaburn.composeapp.generated.resources.camp_pin_place_title
import io.asterixorobelix.afrikaburn.Dimens
import org.jetbrains.compose.resources.stringResource

/**
 * Dialog to confirm placing a new camp pin.
 */
@Composable
fun CampPinPlaceDialog(
    onConfirm: () -> Unit,
    onDismiss: () -> Unit
) {
    AlertDialog(
        onDismissRequest = onDismiss,
        title = {
            Text(
                text = stringResource(Res.string.camp_pin_place_title),
                style = MaterialTheme.typography.headlineSmall
            )
        },
        text = {
            Text(
                text = stringResource(Res.string.camp_pin_place_message),
                style = MaterialTheme.typography.bodyMedium
            )
        },
        confirmButton = {
            Button(onClick = onConfirm) {
                Text(stringResource(Res.string.camp_pin_place_confirm))
            }
        },
        dismissButton = {
            TextButton(onClick = onDismiss) {
                Text(stringResource(Res.string.camp_pin_cancel))
            }
        }
    )
}

/**
 * Dialog showing options for existing camp pin (move/delete).
 */
@Composable
fun CampPinOptionsDialog(
    onMoveRequest: () -> Unit,
    onDeleteRequest: () -> Unit,
    onDismiss: () -> Unit
) {
    AlertDialog(
        onDismissRequest = onDismiss,
        title = {
            Text(
                text = stringResource(Res.string.camp_pin_options_title),
                style = MaterialTheme.typography.headlineSmall
            )
        },
        text = {
            Column {
                OutlinedButton(
                    onClick = onMoveRequest,
                    modifier = Modifier.fillMaxWidth()
                ) {
                    Text(stringResource(Res.string.camp_pin_move))
                }
                Spacer(modifier = Modifier.height(Dimens.paddingSmall))
                OutlinedButton(
                    onClick = onDeleteRequest,
                    modifier = Modifier.fillMaxWidth(),
                    colors = ButtonDefaults.outlinedButtonColors(
                        contentColor = MaterialTheme.colorScheme.error
                    )
                ) {
                    Text(stringResource(Res.string.camp_pin_delete))
                }
            }
        },
        confirmButton = {},
        dismissButton = {
            TextButton(onClick = onDismiss) {
                Text(stringResource(Res.string.camp_pin_cancel))
            }
        }
    )
}

/**
 * Dialog to confirm moving camp pin to new location.
 */
@Composable
fun CampPinMoveDialog(
    onConfirm: () -> Unit,
    onDismiss: () -> Unit
) {
    AlertDialog(
        onDismissRequest = onDismiss,
        title = {
            Text(
                text = stringResource(Res.string.camp_pin_move_title),
                style = MaterialTheme.typography.headlineSmall
            )
        },
        text = {
            Text(
                text = stringResource(Res.string.camp_pin_move_message),
                style = MaterialTheme.typography.bodyMedium
            )
        },
        confirmButton = {
            Button(onClick = onConfirm) {
                Text(stringResource(Res.string.camp_pin_move_confirm))
            }
        },
        dismissButton = {
            TextButton(onClick = onDismiss) {
                Text(stringResource(Res.string.camp_pin_cancel))
            }
        }
    )
}

/**
 * Dialog to confirm deleting camp pin.
 */
@Composable
fun CampPinDeleteDialog(
    onConfirm: () -> Unit,
    onDismiss: () -> Unit
) {
    AlertDialog(
        onDismissRequest = onDismiss,
        title = {
            Text(
                text = stringResource(Res.string.camp_pin_delete_title),
                style = MaterialTheme.typography.headlineSmall
            )
        },
        text = {
            Text(
                text = stringResource(Res.string.camp_pin_delete_message),
                style = MaterialTheme.typography.bodyMedium
            )
        },
        confirmButton = {
            Button(
                onClick = onConfirm,
                colors = ButtonDefaults.buttonColors(
                    containerColor = MaterialTheme.colorScheme.error
                )
            ) {
                Text(stringResource(Res.string.camp_pin_delete_confirm))
            }
        },
        dismissButton = {
            TextButton(onClick = onDismiss) {
                Text(stringResource(Res.string.camp_pin_cancel))
            }
        }
    )
}
```

All dialogs use Material Design 3 components and string resources. Delete confirmation uses error color to indicate destructive action.
  </action>
  <verify>File compiles: `cd /Users/nathanstasin/Documents/afrikaburn_companion/mobile && ./gradlew :composeApp:compileCommonMainKotlinMetadata 2>&1 | tail -10`</verify>
  <done>CampPinDialog composables created</done>
</task>

<task type="auto">
  <name>Task 6: Add camp pin marker layer to MapScreen</name>
  <files>mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/ui/screens/map/MapScreen.kt</files>
  <action>
Update MapScreen to display the user's camp pin marker:

1. Add constant for camp pin color (orange to distinguish from camps/artworks/user):
```kotlin
private const val CAMP_PIN_COLOR = 0xFFFF9800 // Orange
```

2. In MapContent composable, add a CircleLayer for the camp pin when it exists.
Find where other CircleLayers are defined (camp-markers, artwork-markers, user-location) and add:

```kotlin
// User's camp pin marker (orange, larger than other markers)
val userCampPin = uiState.userCampPin
if (userCampPin is CampPinState.Placed) {
    val campPinGeoJson = """
        {
            "type": "FeatureCollection",
            "features": [{
                "type": "Feature",
                "properties": { "type": "camp-pin" },
                "geometry": {
                    "type": "Point",
                    "coordinates": [${userCampPin.longitude}, ${userCampPin.latitude}]
                }
            }]
        }
    """.trimIndent()

    GeoJsonSource(
        id = "camp-pin-source",
        data = campPinGeoJson
    ) {
        CircleLayer(
            id = "camp-pin-layer",
            color = const(Color(CAMP_PIN_COLOR)),
            radius = const(14.dp), // Larger than other markers
            strokeWidth = const(3.dp),
            strokeColor = const(Color.White)
        )
    }
}
```

Note: The exact implementation depends on how MapLibre Compose handles dynamic sources. You may need to use remember/LaunchedEffect to update the source when pin changes.

Alternative approach if GeoJsonSource needs to be static:
- Create the source with empty features initially
- Update the source data when userCampPin changes
  </action>
  <verify>Camp pin layer code added: `grep -n "camp-pin" mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/ui/screens/map/MapScreen.kt`</verify>
  <done>Camp pin marker layer added to MapScreen</done>
</task>

<task type="auto">
  <name>Task 7: Add long-press gesture handling to MapScreen</name>
  <files>mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/ui/screens/map/MapScreen.kt</files>
  <action>
Add onMapLongClick handler to MaplibreMap:

MapLibre Compose should support onMapLongClick similar to onMapClick. Find the MaplibreMap composable and add:

```kotlin
MaplibreMap(
    modifier = Modifier.fillMaxSize(),
    baseStyle = BaseStyle.Uri(Res.getUri(MAP_STYLE_PATH)),
    cameraState = cameraState,
    onMapClick = { pos, offset ->
        // Existing click handling for markers...
    },
    onMapLongClick = { pos, offset ->
        // Long press - trigger camp pin interaction
        viewModel.onMapLongPress(
            latitude = pos.latitude,
            longitude = pos.longitude
        )
        ClickResult.Consume
    }
) {
    // Map content layers...
}
```

If MapLibre Compose doesn't have onMapLongClick, you may need to:
1. Check the library documentation for long-press support
2. Use a Modifier.pointerInput with detectTapGestures for long-press
3. Convert screen coordinates to geo coordinates using projection

Alternative with Modifier:
```kotlin
Box(
    modifier = Modifier
        .fillMaxSize()
        .pointerInput(Unit) {
            detectTapGestures(
                onLongPress = { offset ->
                    // Convert offset to lat/lng using cameraState.projection
                    val latLng = cameraState.projection?.toLatLng(offset)
                    latLng?.let {
                        viewModel.onMapLongPress(it.latitude, it.longitude)
                    }
                }
            )
        }
) {
    MaplibreMap(...)
}
```

Choose the approach that works with MapLibre Compose 0.11.1.
  </action>
  <verify>Long-press handling added: `grep -n "onMapLongPress\|onMapLongClick\|onLongPress" mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/ui/screens/map/MapScreen.kt`</verify>
  <done>Long-press gesture handling added</done>
</task>

<task type="auto">
  <name>Task 8: Integrate dialogs into MapScreen</name>
  <files>mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/ui/screens/map/MapScreen.kt</files>
  <action>
Add dialog rendering to MapScreen based on campPinDialogState:

In the MapScreen or MapContent composable, after the map content, add dialog handling:

```kotlin
@Composable
fun MapScreen(
    viewModel: MapViewModel = koinInject(),
    onProjectClick: (ProjectItem) -> Unit = {}
) {
    val uiState by viewModel.uiState.collectAsState()

    Box(modifier = Modifier.fillMaxSize()) {
        when (val state = uiState) {
            is MapUiState.Loading -> LoadingContent()
            is MapUiState.Error -> ErrorContent(state.message)
            is MapUiState.Success -> {
                MapContent(
                    uiState = state,
                    viewModel = viewModel,
                    onProjectClick = onProjectClick
                )

                // Camp pin dialogs
                when (val dialogState = state.campPinDialogState) {
                    is CampPinDialogState.Hidden -> { /* No dialog */ }

                    is CampPinDialogState.ConfirmPlace -> {
                        CampPinPlaceDialog(
                            onConfirm = { viewModel.confirmPlacePin() },
                            onDismiss = { viewModel.dismissDialog() }
                        )
                    }

                    is CampPinDialogState.PinOptions -> {
                        CampPinOptionsDialog(
                            onMoveRequest = {
                                // Dismiss options, user will long-press new location
                                viewModel.dismissDialog()
                            },
                            onDeleteRequest = { viewModel.showDeleteConfirmation() },
                            onDismiss = { viewModel.dismissDialog() }
                        )
                    }

                    is CampPinDialogState.ConfirmMove -> {
                        CampPinMoveDialog(
                            onConfirm = { viewModel.confirmMovePin() },
                            onDismiss = { viewModel.dismissDialog() }
                        )
                    }

                    is CampPinDialogState.ConfirmDelete -> {
                        CampPinDeleteDialog(
                            onConfirm = { viewModel.confirmDeletePin() },
                            onDismiss = { viewModel.dismissDialog() }
                        )
                    }
                }
            }
        }
    }
}
```

Add necessary imports for CampPinDialogState and dialog composables.
  </action>
  <verify>Dialogs integrated: `grep -n "CampPinDialogState\|CampPinPlaceDialog\|CampPinOptionsDialog" mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/ui/screens/map/MapScreen.kt`</verify>
  <done>Dialogs integrated into MapScreen</done>
</task>

<task type="auto">
  <name>Task 9: Full build and detekt</name>
  <files>N/A</files>
  <action>
Run full build and code quality checks:

```bash
cd /Users/nathanstasin/Documents/afrikaburn_companion/mobile && ./gradlew :composeApp:assembleDebug
```

Then run detekt:
```bash
./gradlew detekt
```

Fix any issues:
- Long parameter lists: extract to data classes
- Magic numbers: define as constants (CAMP_PIN_COLOR already done)
- Import organization
- Line length issues
  </action>
  <verify>Build and detekt pass: `cd /Users/nathanstasin/Documents/afrikaburn_companion/mobile && ./gradlew :composeApp:assembleDebug detekt 2>&1 | tail -20`</verify>
  <done>Build and code quality checks pass</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete camp pin feature: long-press to place, orange marker, move/delete functionality with persistence</what-built>
  <how-to-verify>
    1. Run the app: `./mobile/gradlew -p mobile :composeApp:installDebug`
    2. Navigate to Map tab
    3. **PIN-01 Test - Place pin:**
       - Long-press on an empty area of the map
       - Verify: Confirmation dialog appears asking "Place Your Camp Pin?"
       - Tap "Place Pin"
       - Verify: Orange marker appears at long-pressed location
    4. **PIN-02 Test - Persistence:**
       - Close the app completely (force stop)
       - Reopen the app, go to Map tab
       - Verify: Orange camp pin marker is still visible at same location
    5. **PIN-03 Test - Move pin:**
       - Long-press on a different area of the map (not on the pin)
       - Verify: Move confirmation dialog appears
       - Tap "Move Here"
       - Verify: Orange marker moves to new location
    6. **PIN-04 Test - Delete pin:**
       - Long-press on the orange marker (or nearby)
       - Verify: Options dialog appears with "Move Pin" and "Delete Pin"
       - Tap "Delete Pin"
       - Verify: Delete confirmation dialog appears
       - Tap "Delete"
       - Verify: Orange marker disappears
    7. **Verify visual distinction:**
       - Place a new camp pin
       - Verify: Orange pin is visually distinct from purple camps, teal artworks, and blue user location
  </how-to-verify>
  <resume-signal>Type "approved" if all camp pin features work correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `./gradlew :composeApp:assembleDebug` succeeds
- [ ] `./gradlew detekt` passes
- [ ] Long-press on empty map shows place confirmation
- [ ] Placing pin shows orange marker
- [ ] Pin persists after app restart
- [ ] Long-press elsewhere shows move confirmation
- [ ] Long-press on pin shows options dialog
- [ ] Delete removes the pin
- [ ] Orange color distinguishes camp pin from other markers
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Human verification approved
- PIN-01: User can place a camp pin by long-pressing on the map
- PIN-02: User's camp pin persists after closing and reopening the app
- PIN-03: User can move their camp pin to a new location
- PIN-04: User can delete their camp pin
- v3.0 Offline Map milestone complete
</success_criteria>

<output>
After completion, create `.planning/phases/04-user-camp-pin/04-02-SUMMARY.md`
</output>
