---
phase: 05-event-config
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/domain/model/EventConfig.kt
  - mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/domain/service/EventDateService.kt
  - mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/di/DomainModule.kt
  - mobile/composeApp/src/commonTest/kotlin/io/asterixorobelix/afrikaburn/domain/service/EventDateServiceTest.kt
autonomous: true
must_haves:
  truths:
    - "App has hardcoded AfrikaBurn 2026 event configuration (date, coordinates, radius)"
    - "EventDateService correctly determines if current date is past event start"
    - "Debug feature flag exists to bypass surprise mode in dev builds"
    - "All unit tests pass with 80%+ coverage"
  artifacts:
    - path: "mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/domain/model/EventConfig.kt"
      provides: "Event configuration data model"
      min_lines: 20
      contains: "data class EventConfig"
    - path: "mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/domain/service/EventDateService.kt"
      provides: "Date detection service"
      min_lines: 30
      exports: ["EventDateService", "isEventStarted"]
    - path: "mobile/composeApp/src/commonTest/kotlin/io/asterixorobelix/afrikaburn/domain/service/EventDateServiceTest.kt"
      provides: "Comprehensive unit tests"
      min_lines: 80
  key_links:
    - from: "mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/domain/service/EventDateService.kt"
      to: "EventConfig"
      via: "uses event configuration"
      pattern: "EventConfig"
---

<objective>
Implement Event Configuration and Date Detection for Surprise Mode

Purpose: Create the foundation for v3.1 Event Surprise Mode by defining event configuration (date, location, geofence radius) and implementing date-based unlock detection.

Output: EventConfig data model, EventDateService with isEventStarted() logic, debug feature flag, and comprehensive TDD unit tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing patterns to follow:
@mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/domain/repository/UserCampPinRepository.kt
@mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/di/DomainModule.kt
@mobile/composeApp/src/commonTest/kotlin/io/asterixorobelix/afrikaburn/models/ProjectItemTest.kt
</context>

<feature>
  <name>Event Date Configuration and Detection</name>
  <files>
    mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/domain/model/EventConfig.kt,
    mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/domain/service/EventDateService.kt,
    mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/di/DomainModule.kt,
    mobile/composeApp/src/commonTest/kotlin/io/asterixorobelix/afrikaburn/domain/service/EventDateServiceTest.kt
  </files>
  <behavior>
    EventConfig data class:
    - eventStartDate: LocalDate (AfrikaBurn 2026 start date - typically late April)
    - eventEndDate: LocalDate (AfrikaBurn 2026 end date)
    - eventLatitude: Double (Tankwa Karoo coordinates: approximately -32.3266)
    - eventLongitude: Double (approximately 19.7437)
    - geofenceRadiusKm: Double (20.0 km as per requirements)

    EventDateService:
    - isEventStarted(): Boolean -> true if current date >= eventStartDate
    - isEventActive(): Boolean -> true if current date between start and end
    - getEventConfig(): EventConfig -> returns the bundled configuration

    Debug Feature Flag:
    - BYPASS_SURPRISE_MODE: Boolean -> defaults to false, true only in debug builds
    - isUnlockBypassed(): Boolean -> returns true if flag is enabled

    Test cases:
    - isEventStarted() returns false when current date is before event start
    - isEventStarted() returns true when current date equals event start
    - isEventStarted() returns true when current date is after event start
    - isEventActive() returns true only during event dates
    - Debug flag bypasses surprise mode when enabled
  </behavior>
  <implementation>
    1. Create EventConfig data class with hardcoded AfrikaBurn 2026 values
    2. Create EventDateService interface and implementation
    3. Inject Clock dependency for testable time-based logic
    4. Register in DomainModule for Koin DI
    5. Write comprehensive unit tests using fake Clock
  </implementation>
</feature>

<tasks>

<task type="auto">
  <name>Task 1: RED - Write failing tests for EventDateService</name>
  <files>
    mobile/composeApp/src/commonTest/kotlin/io/asterixorobelix/afrikaburn/domain/service/EventDateServiceTest.kt
  </files>
  <action>
    Create EventDateServiceTest with comprehensive tests for date detection:

    1. Create test file following project conventions (Kotlin Test framework)
    2. Define test cases for all behaviors:
       - `isEventStarted returns false before event start date`
       - `isEventStarted returns true on event start date`
       - `isEventStarted returns true after event start date`
       - `isEventActive returns false before event`
       - `isEventActive returns true during event`
       - `isEventActive returns false after event`
       - `getEventConfig returns expected configuration`
       - `debug flag bypass returns true when enabled`
       - `debug flag bypass returns false when disabled (default)`

    3. Use FakeClock pattern (create interface Clock with now() method, fake implementation for tests)
    4. Tests MUST fail initially (RED phase - no implementation yet)

    Do NOT create the production code yet - only the tests.

    Important: Use kotlinx.datetime for date handling (already in project dependencies).
  </action>
  <verify>
    Run: cd mobile && ./gradlew :composeApp:testDebugUnitTest --tests "*EventDateServiceTest*"
    Expected: Tests fail with compilation errors (classes don't exist yet) or assertion failures
  </verify>
  <done>
    EventDateServiceTest.kt exists with 8+ test cases that all fail
    Commit: test(05-01): add failing tests for EventDateService
  </done>
</task>

<task type="auto">
  <name>Task 2: GREEN - Implement EventConfig and EventDateService</name>
  <files>
    mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/domain/model/EventConfig.kt,
    mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/domain/service/EventDateService.kt
  </files>
  <action>
    Create minimal implementation to make tests pass:

    1. Create domain/model/EventConfig.kt:
       - Data class with: eventStartDate, eventEndDate, eventLatitude, eventLongitude, geofenceRadiusKm
       - Companion object with DEFAULT containing AfrikaBurn 2026 dates
       - Use kotlinx.datetime.LocalDate for dates

    2. Create domain/service/EventDateService.kt:
       - Interface EventDateService with methods: isEventStarted(), isEventActive(), getEventConfig()
       - Interface Clock with now(): Instant (for testability)
       - DefaultClock implementation using kotlinx.datetime.Clock.System
       - EventDateServiceImpl taking Clock as dependency
       - BYPASS_SURPRISE_MODE companion object constant (false by default)
       - isUnlockBypassed() method checking the flag

    3. AfrikaBurn 2026 dates (verify actual dates, typically late April):
       - Start: 2026-04-27 (Monday, event typically starts)
       - End: 2026-05-03 (Sunday)
       - Location: -32.3266, 19.7437 (Tankwa Karoo)
       - Radius: 20.0 km

    Focus: Make tests pass with minimal, clean code. No premature optimization.
  </action>
  <verify>
    Run: cd mobile && ./gradlew :composeApp:testDebugUnitTest --tests "*EventDateServiceTest*"
    Expected: All tests pass (GREEN)
  </verify>
  <done>
    All EventDateService tests pass
    Commit: feat(05-01): implement EventConfig and EventDateService
  </done>
</task>

<task type="auto">
  <name>Task 3: REFACTOR - Register in DI and verify coverage</name>
  <files>
    mobile/composeApp/src/commonMain/kotlin/io/asterixorobelix/afrikaburn/di/DomainModule.kt
  </files>
  <action>
    1. Add to DomainModule.kt:
       - single<Clock> { DefaultClock() }
       - single<EventDateService> { EventDateServiceImpl(get()) }

    2. Run full test suite and detekt:
       - Ensure no regressions
       - Verify code style compliance

    3. Review code for any obvious improvements:
       - Clean up any duplication
       - Ensure consistent naming
       - Add KDoc comments if missing

    Only commit if changes made during refactor.
  </action>
  <verify>
    Run: cd mobile && ./gradlew :composeApp:testDebugUnitTest detekt
    Expected: All tests pass, no detekt violations
  </verify>
  <done>
    - EventDateService registered in Koin DI
    - All tests pass
    - No detekt violations
    Commit: refactor(05-01): register EventDateService in DI
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] cd mobile && ./gradlew :composeApp:testDebugUnitTest --tests "*EventDateServiceTest*" passes
- [ ] cd mobile && ./gradlew detekt passes
- [ ] cd mobile && ./gradlew :composeApp:testDebugUnitTest passes (full suite)
- [ ] EventConfig contains AfrikaBurn 2026 configuration
- [ ] EventDateService correctly detects if event has started
- [ ] Debug bypass flag exists and is testable
</verification>

<success_criteria>
- RED: Failing tests written and committed
- GREEN: Implementation passes all tests
- REFACTOR: Code registered in DI, style clean
- 2-3 atomic commits produced
- Phase 5 requirements SURP-01, SURP-02, SURP-07 addressed
</success_criteria>

<output>
After completion, create `.planning/phases/05-event-config/05-01-SUMMARY.md` with:
- RED: What tests were written, why they failed initially
- GREEN: What implementation made them pass
- REFACTOR: What cleanup was done
- Commits: List of commits produced
- Requirements satisfied: SURP-01, SURP-02, SURP-07
</output>
