name: Capture App Screenshots

on:
  workflow_dispatch:
  workflow_call:

jobs:
  android-screenshots:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    defaults:
      run:
        working-directory: mobile

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Set up JDK 17
      uses: actions/setup-java@v5
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('mobile/**/*.gradle*', 'mobile/**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.3'
        bundler-cache: true
        working-directory: mobile/fastlane

    - name: Make gradlew executable
      run: chmod +x ./gradlew

    - name: Enable KVM
      run: |
        echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
        sudo udevadm control --reload-rules
        sudo udevadm trigger --name-match=kvm

    - name: Build debug APK and test APK
      run: |
        ./gradlew :composeApp:assembleDebug :composeApp:assembleDebugAndroidTest

    - name: Capture Android screenshots
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 34
        target: google_apis
        arch: x86_64
        profile: pixel_6
        emulator-options: -no-window -no-audio -no-boot-anim -gpu swiftshader_indirect -no-snapshot
        disable-animations: true
        working-directory: mobile/fastlane
        script: bundle exec fastlane android screenshots

    - name: Upload Android screenshots
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: android-screenshots
        path: mobile/fastlane/screenshots/android
        if-no-files-found: warn

  ios-screenshots:
    runs-on: macos-15
    timeout-minutes: 45

    defaults:
      run:
        working-directory: mobile

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Set up JDK 17
      uses: actions/setup-java@v5
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: 'latest-stable'

    - name: Restore Gradle and Kotlin/Native cache
      uses: actions/cache/restore@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          ~/.konan
        key: ${{ runner.os }}-gradle-konan-${{ hashFiles('mobile/**/*.gradle*', 'mobile/**/gradle-wrapper.properties', 'mobile/gradle/libs.versions.toml') }}
        restore-keys: |
          ${{ runner.os }}-gradle-konan-
          ${{ runner.os }}-gradle-

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.3'
        bundler-cache: true
        working-directory: mobile/fastlane

    - name: Make gradlew executable
      run: chmod +x ./gradlew

    - name: Configure Gradle for CI
      run: |
        cat >> gradle.properties << 'GRADLE_EOF'
        org.gradle.jvmargs=-Xmx6g -XX:MaxMetaspaceSize=1g -XX:+UseG1GC
        org.gradle.parallel=true
        org.gradle.daemon=false
        org.gradle.configureondemand=true
        org.gradle.caching=true
        kotlin.native.ignoreDisabledTargets=true
        kotlin.native.useXcodeMessageStyle=true
        kotlin.incremental.native=true
        android.useAndroidX=true
        android.enableJetifier=false
        GRADLE_EOF

    - name: Build debug XCFramework for simulator
      timeout-minutes: 30
      run: |
        ./gradlew :composeApp:assembleDebugXCFramework --no-daemon

    - name: Install CocoaPods dependencies
      run: |
        cd iosApp
        pod install --repo-update

    - name: Save Gradle and Kotlin/Native cache
      if: always()
      uses: actions/cache/save@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          ~/.konan
        key: ${{ runner.os }}-gradle-konan-${{ hashFiles('mobile/**/*.gradle*', 'mobile/**/gradle-wrapper.properties', 'mobile/gradle/libs.versions.toml') }}

    - name: Update Snapshot Helper
      run: |
        cd iosApp
        bundle exec --gemfile=../fastlane/Gemfile fastlane snapshot update --force

    - name: Capture iOS screenshots
      working-directory: mobile/fastlane
      run: bundle exec fastlane ios screenshots

    - name: Upload iOS screenshots
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ios-screenshots
        path: mobile/fastlane/screenshots/ios
        if-no-files-found: warn
