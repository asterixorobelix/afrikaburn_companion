name: Mobile Continuous Deployment (CD)

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Type of version bump'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        default: 'patch'
      release_notes:
        description: 'Additional release notes (optional)'
        required: false
        type: string

jobs:
  version-and-build:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.version.outputs.new_version }}
      version_code: ${{ steps.version.outputs.version_code }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up JDK 17
      uses: actions/setup-java@v5
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
    
    - name: Set up Firebase Configuration for Release
      run: |
        echo "ðŸ”¥ Setting up Firebase for production release..."
        
        # Check if Firebase configuration secret is available
        if [ -z "${{ secrets.GOOGLE_SERVICES_JSON }}" ]; then
          echo "âš ï¸ GOOGLE_SERVICES_JSON secret not found."
          echo "Using default configuration - Crashlytics will be disabled."
          echo "To enable Crashlytics for releases, add your google-services.json as a base64 encoded repository secret."
        else
          echo "âœ… Firebase configuration secret found. Setting up for production release."
          echo "${{ secrets.GOOGLE_SERVICES_JSON }}" | base64 --decode > mobile/composeApp/google-services.json
          echo "ðŸ”¥ Firebase Crashlytics enabled for this release build."
        fi

    - name: Make gradlew executable
      run: chmod +x mobile/gradlew
    
    - name: Initialize Gradle wrapper
      run: |
        cd mobile
        gradle wrapper --gradle-version 8.13

    - name: Enforce Gradle wrapper version
      run: |
        cd mobile
        perl -pi -e 's/gradle-8\\.13\\.2-bin/gradle-8.13-bin/' gradle/wrapper/gradle-wrapper.properties
    
    - name: Get current version and calculate new version
      id: version
      run: |
        cd mobile
        
        # Get current version from build.gradle.kts
        CURRENT_VERSION=$(grep 'versionName = ' composeApp/build.gradle.kts | sed 's/.*versionName = "\(.*\)".*/\1/')
        CURRENT_CODE=$(grep 'versionCode = ' composeApp/build.gradle.kts | sed 's/.*versionCode = \(.*\)/\1/')
        
        echo "Current version: $CURRENT_VERSION"
        echo "Current version code: $CURRENT_CODE"
        
        # Parse semantic version
        IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
        MAJOR=${VERSION_PARTS[0]}
        MINOR=${VERSION_PARTS[1]}
        PATCH=${VERSION_PARTS[2]}
        
        # Bump version based on input
        case "${{ github.event.inputs.version_bump }}" in
          "major")
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
            ;;
          "minor")
            MINOR=$((MINOR + 1))
            PATCH=0
            ;;
          "patch")
            PATCH=$((PATCH + 1))
            ;;
        esac
        
        NEW_VERSION="$MAJOR.$MINOR.$PATCH"
        # Ensure monotonically increasing version codes for CI builds.
        # Prefer GitHub run number (global monotonic), fallback to current+1.
        if [ -n "${{ github.run_number }}" ]; then
          if [ "${{ github.run_number }}" -gt "$CURRENT_CODE" ]; then
            NEW_VERSION_CODE=${{ github.run_number }}
          else
            NEW_VERSION_CODE=$((CURRENT_CODE + 1))
          fi
        else
          NEW_VERSION_CODE=$((CURRENT_CODE + 1))
        fi
        
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "version_code=$NEW_VERSION_CODE" >> $GITHUB_OUTPUT
        
        echo "New version: $NEW_VERSION"
        echo "New version code: $NEW_VERSION_CODE"
    
    - name: Update version in build.gradle.kts
      run: |
        cd mobile
        sed -i "s/versionName = \".*\"/versionName = \"${{ steps.version.outputs.new_version }}\"/" composeApp/build.gradle.kts
        sed -i "s/versionCode = .*/versionCode = ${{ steps.version.outputs.version_code }}/" composeApp/build.gradle.kts
    
    - name: Generate changelog
      id: changelog
      run: |
        cd mobile
        
        # Get the last tag
        LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        
        if [ -z "$LAST_TAG" ]; then
          echo "No previous tags found, generating changelog from all commits"
          COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges)
        else
          echo "Generating changelog since $LAST_TAG"
          COMMITS=$(git log $LAST_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges)
        fi
        
        # Create changelog content
        CHANGELOG="## What's Changed in v${{ steps.version.outputs.new_version }}
        
        $COMMITS"
        
        if [ ! -z "${{ github.event.inputs.release_notes }}" ]; then
          CHANGELOG="$CHANGELOG
        
        ## Additional Notes
        ${{ github.event.inputs.release_notes }}"
        fi
        
        # Save changelog to file
        echo "$CHANGELOG" > CHANGELOG.md
        
        # Save changelog to output (escape newlines)
        {
          echo 'changelog<<EOF'
          echo "$CHANGELOG"
          echo 'EOF'
        } >> $GITHUB_OUTPUT
    
    - name: Note
      run: |
        echo "â„¹ï¸ Version bump is applied only in the CI workspace."
        echo "â„¹ï¸ Tags/releases are created via the GitHub Release step (no push to main)."
    
    - name: Build Android AAB
      run: |
        cd mobile
        ./gradlew :composeApp:bundleRelease
    
    - name: Sign Android AAB
      run: |
        echo "${{ secrets.ANDROID_SIGNING_KEY }}" | base64 --decode > /tmp/keystore.jks
        jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
          -keystore /tmp/keystore.jks \
          -storepass "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" \
          -keypass "${{ secrets.ANDROID_KEY_PASSWORD }}" \
          mobile/composeApp/build/outputs/bundle/release/*.aab \
          "${{ secrets.ANDROID_KEY_ALIAS }}"
        rm -f /tmp/keystore.jks
    
    - name: Upload AAB artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-aab
        path: mobile/composeApp/build/outputs/bundle/release/*.aab

  deploy-android:
    runs-on: ubuntu-latest
    needs: version-and-build
    if: success()
    env:
      NEW_VERSION: ${{ needs.version-and-build.outputs.new_version }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Download signed AAB
      uses: actions/download-artifact@v4
      with:
        name: android-aab
        path: ./artifacts/

    - name: List artifacts
      run: |
        echo "ðŸ“¦ Downloaded artifacts:"
        ls -la ./artifacts/

    - name: Set up JDK 17
      uses: actions/setup-java@v5
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.3'
        bundler-cache: true
        working-directory: mobile/fastlane

    - name: Stage AAB for fastlane
      run: |
        mkdir -p mobile/composeApp/build/outputs/bundle/release
        cp ./artifacts/*.aab mobile/composeApp/build/outputs/bundle/release/composeApp-release.aab

    - name: Create whatsnew directory
      run: |
        mkdir -p distribution/whatsnew
        echo "Bug fixes and improvements" > distribution/whatsnew/whatsnew-en-US

    - name: Capture Android screenshots
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 34
        target: google_apis
        arch: x86_64
        disable-animations: true
        emulator-boot-timeout: 1200
        script: |
          set +e
          cd mobile/fastlane && bundle exec fastlane android screenshots
          exit 0

    - name: Upload to Google Play Internal Testing (fastlane)
      working-directory: mobile/fastlane
      env:
        GOOGLE_PLAY_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
      run: |
        bundle exec fastlane android upload_internal metadata_path:metadata/android

    - name: Deployment Success
      run: |
        echo "ðŸŽ‰ Successfully deployed v$NEW_VERSION to Google Play Internal Testing!"
        echo "ðŸ“± Go to Play Console to promote to other tracks when ready."

  build-ios:
    runs-on: macos-latest
    timeout-minutes: 60
    needs: version-and-build
    if: success()
    env:
      MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}
      MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
      MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      ITC_TEAM_ID: ${{ secrets.ITC_TEAM_ID }}
      ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
      ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
      ASC_KEY_CONTENT: ${{ secrets.ASC_KEY_CONTENT }}

    steps:
    - name: Validate required secrets
      run: |
        MISSING=""
        if [ -z "$MATCH_GIT_BASIC_AUTHORIZATION" ]; then
          MISSING="${MISSING}
          - MATCH_GIT_BASIC_AUTHORIZATION: Base64 of username:PAT for the fastlane-certificates repo.
            If your PAT expired, generate a new one at:
            GitHub > Settings > Developer settings > Personal access tokens > Fine-grained tokens
            Grant 'Contents: Read and write' on asterixorobelix/fastlane-certificates
            Then run: echo -n 'asterixorobelix:NEW_TOKEN' | base64
            Add the output as this secret."
        fi
        if [ -z "$MATCH_PASSWORD" ]; then
          MISSING="${MISSING}
          - MATCH_PASSWORD: The passphrase used to encrypt certificates in the fastlane-certificates repo.
            This is the password you chose when running 'fastlane match appstore' locally."
        fi
        if [ -z "$MATCH_GIT_URL" ]; then
          MISSING="${MISSING}
          - MATCH_GIT_URL: Set to https://github.com/asterixorobelix/fastlane-certificates"
        fi
        if [ -z "$APPLE_TEAM_ID" ]; then
          MISSING="${MISSING}
          - APPLE_TEAM_ID: Apple Developer Team ID from https://developer.apple.com/account > Membership"
        fi
        if [ -z "$ASC_KEY_ID" ] || [ -z "$ASC_ISSUER_ID" ] || [ -z "$ASC_KEY_CONTENT" ]; then
          MISSING="${MISSING}
          - ASC_KEY_ID / ASC_ISSUER_ID / ASC_KEY_CONTENT: App Store Connect API Key for TestFlight upload.
            Create at: https://appstoreconnect.apple.com/access/integrations/api
            ASC_KEY_ID = Key ID, ASC_ISSUER_ID = Issuer ID
            ASC_KEY_CONTENT = base64-encoded .p8 file: base64 -i AuthKey_XXXXX.p8"
        fi

        if [ -n "$MISSING" ]; then
          echo "::error::iOS build failed - missing GitHub Actions secrets:${MISSING}"
          echo ""
          echo "Add secrets at: https://github.com/$GITHUB_REPOSITORY/settings/secrets/actions"
          exit 1
        fi
        echo "All required iOS secrets are configured."

    - name: Checkout code
      uses: actions/checkout@v5
      with:
        ref: main
        fetch-depth: 0

    - name: Sync iOS version with Android
      run: |
        NEW_VERSION="${{ needs.version-and-build.outputs.new_version }}"
        VERSION_CODE="${{ needs.version-and-build.outputs.version_code }}"
        echo "Setting iOS version to $NEW_VERSION ($VERSION_CODE)"

        # Update project.pbxproj (both Debug and Release build settings)
        sed -i '' "s/CURRENT_PROJECT_VERSION = .*/CURRENT_PROJECT_VERSION = $VERSION_CODE;/" \
          mobile/iosApp/iosApp.xcodeproj/project.pbxproj
        sed -i '' "s/MARKETING_VERSION = .*/MARKETING_VERSION = $NEW_VERSION;/" \
          mobile/iosApp/iosApp.xcodeproj/project.pbxproj

        # Update Config.xcconfig for consistency
        sed -i '' "s/CURRENT_PROJECT_VERSION=.*/CURRENT_PROJECT_VERSION=$VERSION_CODE/" \
          mobile/iosApp/Configuration/Config.xcconfig
        sed -i '' "s/MARKETING_VERSION=.*/MARKETING_VERSION=$NEW_VERSION/" \
          mobile/iosApp/Configuration/Config.xcconfig

        echo "iOS version synced: MARKETING_VERSION=$NEW_VERSION CURRENT_PROJECT_VERSION=$VERSION_CODE"

    - name: Set up JDK 17
      uses: actions/setup-java@v5
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: 'latest-stable'

    - name: Restore Gradle and Kotlin/Native cache
      uses: actions/cache/restore@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          ~/.konan
        key: ${{ runner.os }}-gradle-konan-${{ hashFiles('mobile/**/*.gradle*', 'mobile/**/gradle-wrapper.properties', 'mobile/gradle/libs.versions.toml') }}
        restore-keys: |
          ${{ runner.os }}-gradle-konan-
          ${{ runner.os }}-gradle-

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.3'
        bundler-cache: true
        working-directory: mobile/fastlane

    - name: Set up Firebase Configuration
      run: |
        if [ -n "$GOOGLE_SERVICES_JSON" ]; then
          echo "$GOOGLE_SERVICES_JSON" | base64 --decode > mobile/composeApp/google-services.json
        fi
        if [ -n "$IOS_FIREBASE_CONFIG_PLIST" ]; then
          echo "$IOS_FIREBASE_CONFIG_PLIST" | base64 --decode > mobile/iosApp/iosApp/GoogleService-Info.plist
        fi
      env:
        GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
        IOS_FIREBASE_CONFIG_PLIST: ${{ secrets.IOS_FIREBASE_CONFIG_PLIST }}

    - name: Make gradlew executable
      run: chmod +x mobile/gradlew

    - name: Initialize Gradle wrapper
      run: |
        cd mobile
        gradle wrapper --gradle-version 8.13

    - name: Enforce Gradle wrapper version
      run: |
        cd mobile
        perl -pi -e 's/gradle-8\\.13\\.2-bin/gradle-8.13-bin/' gradle/wrapper/gradle-wrapper.properties

    - name: Configure Gradle for CI
      run: |
        cd mobile
        cat >> gradle.properties << 'GRADLE_EOF'
        org.gradle.jvmargs=-Xmx6g -XX:MaxMetaspaceSize=1g -XX:+UseG1GC
        org.gradle.parallel=true
        org.gradle.daemon=false
        org.gradle.configureondemand=true
        org.gradle.caching=true
        kotlin.native.ignoreDisabledTargets=true
        kotlin.native.useXcodeMessageStyle=true
        kotlin.incremental.native=true
        android.useAndroidX=true
        android.enableJetifier=false
        GRADLE_EOF

    - name: Build Kotlin/Native framework (arm64 device only)
      timeout-minutes: 30
      run: |
        cd mobile
        ./gradlew :composeApp:assembleReleaseFrameworkDevice --no-daemon

    - name: Install CocoaPods dependencies
      run: |
        cd mobile/iosApp
        pod install --repo-update

    - name: Save Gradle and Kotlin/Native cache
      if: always()
      uses: actions/cache/save@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          ~/.konan
        key: ${{ runner.os }}-gradle-konan-${{ hashFiles('mobile/**/*.gradle*', 'mobile/**/gradle-wrapper.properties', 'mobile/gradle/libs.versions.toml') }}

    - name: Build and deploy iOS to TestFlight
      timeout-minutes: 30
      working-directory: mobile/fastlane
      run: |
        bundle exec fastlane ios beta

    - name: Capture iOS screenshots
      working-directory: mobile/fastlane
      run: |
        bundle exec fastlane ios screenshots

    - name: Upload iOS screenshots to App Store Connect
      working-directory: mobile/fastlane
      run: |
        bundle exec fastlane ios upload_screenshots

    - name: Upload iOS Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ios-ipa
        path: mobile/fastlane/build/*.ipa
        if-no-files-found: warn

  create-release:
    runs-on: ubuntu-latest
    needs: [version-and-build, build-ios]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        ref: main
    
    - name: Download Android AAB
      uses: actions/download-artifact@v4
      with:
        name: android-aab
        path: ./artifacts/
    
    - name: Download iOS IPA
      uses: actions/download-artifact@v4
      with:
        name: ios-ipa
        path: ./artifacts/
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ needs.version-and-build.outputs.new_version }}
        name: Release v${{ needs.version-and-build.outputs.new_version }}
        body: ${{ needs.version-and-build.outputs.changelog }}
        draft: false
        prerelease: false
        files: |
          artifacts/*.aab
          artifacts/*.ipa
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Notify completion
      run: |
        echo "ðŸŽ‰ Release v${{ needs.version-and-build.outputs.new_version }} created successfully!"
        echo "ðŸ“± Android AAB and iOS IPA files have been uploaded to the release."
        echo "ðŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/v${{ needs.version-and-build.outputs.new_version }}"
