platform :ios, '16.0'

target 'iosApp' do
  use_frameworks!

  # MapLibre Native iOS SDK - required at link time by maplibre-compose KMP library
  pod 'MapLibre', '~> 6.8'
end

post_install do |installer|
  installer.pods_project.targets.each do |target|
    target.build_configurations.each do |config|
      config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '16.0'
      # Disable code signing for Pods targets (CI uses Manual signing for app only)
      config.build_settings['CODE_SIGNING_ALLOWED'] = 'NO'
      config.build_settings['CODE_SIGNING_REQUIRED'] = 'NO'
    end
  end

  # Fix xcconfig chain: CocoaPods replaces the base xcconfig on newer Xcode
  # projects (objectVersion 77+, baseConfigurationReferenceAnchor format) but
  # may not #include the original Config.xcconfig. This restores the chain so
  # values like PRODUCT_NAME, PRODUCT_BUNDLE_IDENTIFIER, and OTHER_LDFLAGS
  # defined in Config.xcconfig are inherited correctly.
  installer.generated_projects.each do |project|
    project.build_configurations.each do |config|
      xcconfig_ref = config.base_configuration_reference
      next unless xcconfig_ref

      xcconfig_path = xcconfig_ref.real_path
      next unless xcconfig_path.exist?

      content = xcconfig_path.read
      include_line = '#include "../../Configuration/Config.xcconfig"'
      unless content.include?(include_line)
        xcconfig_path.open('a') { |f| f.puts "\n#{include_line}" }
      end
    end
  end
end
